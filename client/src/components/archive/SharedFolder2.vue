<template>
  <div class="_sharedFolder">
    <transition name="slideup" mode="out-in">
      <StackDisplay
        v-if="opened_stack"
        class="_stackModal"
        :key="opened_stack.$path"
        :stack_path="opened_stack.$path"
        :context="'archive'"
        :can_be_added_to_fav="can_be_added_to_fav"
        :is_favorite="isFavorite(opened_stack.$path)"
        @toggleFav="toggleFav(opened_stack.$path)"
        @prevMedia="navMedia(-1)"
        @nextMedia="navMedia(+1)"
        @close="closeStack"
      />
    </transition>

    <transition name="fade_fast" mode="out-in">
      <div class="_loader" v-if="is_loading_folder">
        <LoaderSpinner />
      </div>
      <div v-else class="_sharedFolder--content">
        <button
          type="button"
          class="u-buttonLink"
          :class="{
            'is--active': show_filter_sort_pane,
          }"
          @click="show_filter_sort_pane = !show_filter_sort_pane"
        >
          {{ $t("filter_sort") }}
        </button>

        <transition name="pagechange" mode="out-in">
          <div class="_filterBar" v-if="show_filter_sort_pane">
            <FilterBar
              :group_mode.sync="group_mode"
              :sort_order.sync="sort_order"
              :search_str.sync="search_str"
              :filetype_filter.sync="filetype_filter"
              :author_path_filter.sync="author_path_filter"
              :available_keywords="available_keywords"
              :keywords_filter.sync="keywords_filter"
              @close="show_filter_sort_pane = false"
            />
          </div>
        </transition>

        <div>
          <ToggleInput :content.sync="fav_filter" :label="$t('only_my_fav')" />
        </div>

        <hr />

        <transition name="pagechange" mode="out-in">
          <transition-group
            tag="div"
            name="projectsList"
            appear
            :key="sort_order + '-' + group_mode"
          >
            <div
              v-if="grouped_stacks.length === 0"
              class="u-instructions _noContent"
              :key="'nocontent'"
            >
              {{ $t("no_content") }}
            </div>
            <template v-else>
              <div
                class="_dayFileSection"
                v-for="{ label, files: stacks } in grouped_stacks"
                :key="label"
              >
                <div class="_label">
                  {{ label }}
                </div>
                <transition-group
                  tag="div"
                  class="_itemGrid"
                  name="listComplete"
                  appear
                >
                  <StackPreview
                    v-for="stack in stacks"
                    :key="stack.$path"
                    :stack="stack"
                    :is_selected="stack.$path === last_selected_stack_path"
                    :can_be_added_to_fav="can_be_added_to_fav"
                    :is_favorite="isFavorite(stack.$path)"
                    @toggleFav="toggleFav(stack.$path)"
                    @openStack="openStack"
                  />
                  <!-- <SharedFolderItem
                class="_file"
                v-for="stack in stacks"
                :key="stack.$path"
                :file="file"
                :is_opened="opened_file && opened_file.$path === file.$path"
                :can_be_added_to_coll="!!opened_collection_slug"
                @open="openFile(file.$path)"
              /> -->
                </transition-group>
              </div>
            </template>
          </transition-group>
        </transition>
      </div>
    </transition>

    <footer class="_footer">
      <small>
        <a
          :href="'mailto:' + $root.app_infos.instance_meta.contactmail"
          target="_blank"
        >
          {{ $t("help_contact") }}
        </a>
        <br />
        {{ $t("version") }} {{ $root.app_infos.version }}

        <!-- <div v-if="is_instance_admin">
          <DownloadFolder :path="shared_folder_path" />
        </div> -->

        <button
          type="button"
          class="u-buttonLink _adminBtn"
          v-if="is_instance_admin"
          @click="show_admin_settings = true"
        >
          {{ $t("admin_settings") }}
        </button>
        <AdminLumaSettings
          v-if="show_admin_settings"
          @close="show_admin_settings = false"
        />
      </small>
    </footer>
  </div>
</template>
<script>
import FilterBar from "@/components/archive/FilterBar.vue";
import StackPreview from "@/components/archive/StackPreview.vue";
import AdminLumaSettings from "@/components/AdminLumaSettings.vue";
import StackDisplay from "@/components/StackDisplay";

export default {
  props: {
    shared_folder_path: String,
  },
  components: {
    FilterBar,
    StackPreview,
    AdminLumaSettings,
    StackDisplay,
  },
  data() {
    return {
      all_stacks: [],

      is_loading_folder: true,
      show_admin_settings: false,

      last_selected_stack_path: undefined,

      show_filter_sort_pane: false,
      sort_order: "date_modified",
      search_str: "",
      filetype_filter: "all",
      author_path_filter: "",
      keywords_filter: [],
      group_mode: "year",

      fav_filter: false,
    };
  },
  i18n: {
    messages: {
      fr: {},
    },
  },
  async created() {},
  async mounted() {
    this.all_stacks = await this.$api.getFolders({
      path: this.stack_shared_folder_path,
    });
    this.$api.join({ room: this.stack_shared_folder_path });
    this.is_loading_folder = false;
  },
  beforeDestroy() {
    this.$api.leave({ room: this.stack_shared_folder_path });
  },
  watch: {
    opened_stack() {
      if (this.opened_stack) {
        this.last_selected_stack_path = this.opened_stack.$path;
      }
    },
  },
  computed: {
    stack_shared_folder_path() {
      return this.shared_folder_path + "/stacks";
    },
    can_be_added_to_fav() {
      return this.connected_as && this.connected_as?.$path !== undefined;
    },
    sorted_stacks() {
      return this.all_stacks
        .slice()
        .sort(
          (a, b) => +new Date(b.$date_modified) - +new Date(a.$date_modified)
        );
    },
    filtered_stacks() {
      return this.sorted_stacks.filter((f) => {
        if (this.fav_filter) if (!this.isFavorite(f.$path)) return false;

        if (this.author_path_filter)
          if (!f.$admins || !f.$admins.includes(this.author_path_filter))
            return false;

        if (this.keywords_filter.length > 0) {
          if (!f.keywords || !Array.isArray(f.keywords)) return false;
          if (this.keywords_filter.some((kwf) => !f.keywords.includes(kwf)))
            return false;
        }
        // if (this.filetype_filter !== "all")
        //   if (!this.fileOrStackContainsType(f, this.filetype_filter))
        //     return false;

        if (this.search_str) {
          if (
            (f.title &&
              f.title.toLowerCase().includes(this.search_str.toLowerCase())) ||
            (f.description &&
              f.description
                .toLowerCase()
                .includes(this.search_str.toLowerCase()))
          )
            return true;
          else return false;
        }

        return true;
      });
    },
    grouped_stacks() {
      let order_props;
      if (this.sort_order === "date_created")
        order_props = [
          "date_created_corrected",
          "$date_created",
          "$date_uploaded",
        ];
      else if (this.sort_order === "date_modified")
        order_props = ["$date_modified"];
      return this.groupFilesBy(
        this.filtered_stacks,
        order_props,
        this.group_mode
      );
    },
    available_keywords() {
      const all_kw = this.filtered_stacks.reduce((acc, f) => {
        if (f.keywords && Array.isArray(f.keywords)) {
          f.keywords.map((kw) => {
            const item = acc.find((_kw) => _kw.title === kw);
            if (item) item.count += 1;
            else acc.push({ title: kw, count: 1 });
            // if (!acc[kw]) acc[kw] = 1;
            // else acc[kw] += 1;
          });
        }
        return acc;
      }, []);
      return all_kw.sort((a, b) => {
        return b.count - a.count;
      });
    },
    opened_stack() {
      if (!this.$route.query?.stack) return false;
      return this.all_stacks.find(
        (s) => this.getFilename(s.$path) === this.$route.query.stack
      );
    },
  },
  methods: {
    openStack(stack_slug) {
      let query = Object.assign({}, this.$route.query) || {};
      query.stack = stack_slug;
      this.$router.push({ query });
    },
    isFavorite(stack_path) {
      if (
        !this.connected_as?.favorites ||
        this.connected_as.favorites.length === 0
      )
        return false;
      return this.connected_as.favorites.some(
        (f) => f.stack_path === stack_path
      );
    },
    async toggleFav(stack_path) {
      let favorites = this.connected_as?.favorites
        ? this.connected_as.favorites.slice()
        : [];

      if (this.isFavorite(stack_path))
        favorites = favorites.filter((f) => f.stack_path !== stack_path);
      else
        favorites.push({
          stack_path,
          added: +new Date(),
        });

      await this.$api.updateMeta({
        path: this.connected_as.$path,
        new_meta: {
          favorites,
        },
      });
    },
    closeStack() {
      let query = Object.assign({}, this.$route.query) || {};
      delete query.stack;
      this.$router.push({ query });
    },
  },
};
</script>
<style lang="scss" scoped>
._sharedFolder {
  position: relative;
  height: 100%;
}

._sharedFolder--content {
  position: relative;
  height: 100%;
  overflow: auto;

  padding: 2px;
  padding: 0 calc(var(--spacing) / 1);

  @include scrollbar(3px, 4px, 4px, transparent, var(--c-noir));
}

._itemGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: calc(var(--spacing) / 1);
}

._label {
  font-weight: 500;
  font-size: var(--sl-font-size-large);
}

._stackModal {
  --sd-separator: rgb(209, 209, 209);
  --sd-textcolor: #333;
  --sd-bg: rgb(245, 245, 245);
}

._footer {
  text-align: center;
  margin: calc(var(--spacing) * 2) auto;
}

._loader {
  position: relative;
  min-height: 80vh;
}
</style>
