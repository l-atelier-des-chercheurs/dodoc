<template>
  <div class="_openedCollection">
    <transition name="slideup" mode="out-in">
      <div class="_spinner" v-if="is_loading" key="loader">
        <LoaderSpinner />
      </div>
      <div v-else key="opened-collection">
        <div v-if="!collection.$path">
          {{ $t("failed_loading") }}
        </div>
        <div v-else :key="collection.$path">
          <div class="_topbar">
            <div class="">
              <button
                type="button"
                class="u-buttonLink"
                @click="$emit('close')"
              >
                <b-icon icon="arrow-left" />
                {{ $t("back") }}
              </button>
            </div>

            <AuthorField
              class="_admins"
              :label="$t('admins')"
              :instructions="$t('media_editing_instructions')"
              :field="'$admins'"
              :authors_paths="collection.$admins"
              :path="collection.$path"
              :can_edit="can_edit"
              :show_image_only="true"
            />

            <DropDown v-if="can_edit">
              <RemoveMenu
                v-if="can_edit"
                :remove_text="$t('remove')"
                @remove="removeCollection"
              />
              <button
                type="button"
                class="u-buttonLink"
                @click="show_qr_code_modal = true"
              >
                <div part="base" class="icon" aria-hidden="true">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-qr-code"
                    viewBox="0 0 16 16"
                  >
                    <path d="M2 2h2v2H2V2Z"></path>
                    <path d="M6 0v6H0V0h6ZM5 1H1v4h4V1ZM4 12H2v2h2v-2Z"></path>
                    <path
                      d="M6 10v6H0v-6h6Zm-5 1v4h4v-4H1Zm11-9h2v2h-2V2Z"
                    ></path>
                    <path
                      d="M10 0v6h6V0h-6Zm5 1v4h-4V1h4ZM8 1V0h1v2H8v2H7V1h1Zm0 5V4h1v2H8ZM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8H6Zm0 0v1H2V8H1v1H0V7h3v1h3Zm10 1h-1V7h1v2Zm-1 0h-1v2h2v-1h-1V9Zm-4 0h2v1h-1v1h-1V9Zm2 3v-1h-1v1h-1v1H9v1h3v-2h1Zm0 0h3v1h-2v1h-1v-2Zm-4-1v1h1v-2H7v1h2Z"
                    ></path>
                    <path d="M7 12h1v3h4v1H7v-4Zm9 2v2h-3v-1h2v-1h1Z"></path>
                  </svg>
                </div>
                {{ $t("direct_link") }}
              </button>
            </DropDown>
            <QRModal
              v-if="show_qr_code_modal"
              :url_to_access="share_url"
              @close="show_qr_code_modal = false"
            >
              <ToggleField
                :label="$t('make_public')"
                :field_name="'$public'"
                :content="collection.$public === true"
                :path="collection.$path"
                :can_edit="can_edit"
              />
            </QRModal>

            <!-- <DropDown v-if="can_edit"> -->
            <!-- </DropDown> -->
          </div>

          <div class="_cont">
            <StorySectionTemplate
              v-if="
                !collection.template ||
                collection.template === '`story_with_sections`'
              "
              :publication="collection"
              :opened_section_meta_filename="opened_section_meta_filename"
              :can_edit="can_edit"
              @toggleSection="toggleSection"
            />
          </div>
        </div>
      </div>
    </transition>
  </div>
</template>
<script>
export default {
  props: {
    opened_collection_slug: String,
  },
  components: {
    StorySectionTemplate: () =>
      import("@/components/publications/templates/StorySectionTemplate.vue"),
  },
  data() {
    return {
      is_loading: true,
      collection: undefined,
      path: "collections/" + this.opened_collection_slug,
      opened_section_meta_filename: "",
      show_qr_code_modal: false,
    };
  },
  i18n: {
    messages: {
      fr: {
        make_public: "AccÃ¨s public (sans mot de passe ou compte)",
      },
      en: {
        make_public: "Allow access to everyone (without password or account)",
      },
    },
  },
  async created() {
    this.collection = await this.$api
      .getFolder({
        path: this.path,
      })
      .catch((err) => {
        this.fetch_stopmotion_error = err.response;
      });

    this.is_loading = false;
    this.$api.join({ room: this.path });

    this.$eventHub.$on("collection.addStack", this.addToStack);
  },
  mounted() {},
  beforeDestroy() {
    this.$api.leave({ room: this.path });
    this.$eventHub.$off("collection.addStack", this.addToStack);
  },
  watch: {},
  computed: {
    can_edit() {
      return this.canLoggedinEditFolder({ folder: this.collection });
    },
    share_url() {
      let query = {};
      // if (this.publication.template === "page_by_page")
      //   query = { display: "slides" };
      // else if (this.publication.template === "story_with_sections")
      query = { display: "section" };

      const route = this.$router.resolve({
        path: this.createURLFromPath(this.collection.$path),
        query,
      });

      return window.location.origin + route.href;
    },
  },
  methods: {
    addToStack() {
      //
    },
    toggleSection(section_meta_filename) {
      this.opened_section_meta_filename = section_meta_filename;
    },
    async updateOpenedCollection() {
      //
    },
    async removeCollection() {
      await this.$api.deleteItem({
        path: this.collection.$path,
      });
      this.$emit("close");
    },
  },
};
</script>
<style lang="scss" scoped>
._openedCollection {
  position: absolute;
  top: 0;
  left: 0;
  background: var(--body-bg);
  height: 100%;
  width: 100%;
  overflow: auto;
}
._spinner {
  padding: calc(var(--spacing) * 2);
}

._topbar {
  display: flex;
  flex-flow: row wrap;
  justify-content: space-between;
  align-items: center;

  padding: calc(var(--spacing) / 1);
  border-bottom: 1px solid var(--c-gris);
}

._cont {
  margin: calc(var(--spacing) / 2) 0;
}

._items {
}

._items--item {
  width: 100%;
  min-height: 2rem;
  margin-bottom: calc(var(--spacing) / 2);
}

._admins {
  ::v-deep ._dLabel {
    display: none;
  }
}
</style>
