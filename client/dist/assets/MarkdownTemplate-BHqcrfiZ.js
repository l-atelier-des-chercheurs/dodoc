import{s as l,p}from"./SingleBaseMediaPicker-C6eWf6Eb.js";import{M as m}from"./MediaPicker-CZryquB9.js";import{n as s}from"../build.js";import{m as r,V as d}from"./ViewContent-BYpnZSBO.js";import"./infinite-viewer.esm-ZcF8ddEx.js";const u={props:{publication:{type:Object,required:!0},can_edit:Boolean},components:{MediaPicker:m},data(){return{show_cover_picker:!1,cover_layout_mode_options:[{key:"",text:this.$t("normal")},{key:"full_page",text:this.$t("full_page")},{key:"text_top_image_down",text:this.$t("text_top_image_down")},{key:"image_top_text_down",text:this.$t("image_top_text_down")}]}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{cover_media(){var a;return(a=this.publication.$files)==null?void 0:a.find(t=>t.cover_type==="front")},cover_image_media(){var e,n;const a=(n=(e=this.cover_media)==null?void 0:e.source_medias)==null?void 0:n[0];if(!a)return!1;const t=this.getSourceMedia({source_media:a,folder_path:this.publication.$path});return t||!1}},methods:{async createCover(){await this.$api.uploadText({path:this.publication.$path,filename:"frontcover.txt",content:this.$t("title"),additional_meta:{cover_type:"front"}})},async removeCover(){this.$api.deleteItem({path:this.cover_media.$path})},async pickCover({path_to_source_media_metas:a}){const t=await this.prepareMediaForPublication({path_to_source_media_meta:a[0],publication_path:this.publication.$path});this.$api.updateMeta({path:this.cover_media.$path,new_meta:{source_medias:[t]}})}}};var h=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_cover"},[t.cover_media?t._e():e("div",{staticClass:"u-spacingBottom"},[e("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button"},on:{click:t.createCover}},[t._v(" "+t._s(t.$t("create_cover"))+" ")])]),t.cover_media?[e("div",{staticClass:"u-spacingBottom"},[e("CollaborativeEditor3",{attrs:{label:t.$t("title"),content:t.cover_media.$content,path:t.cover_media.$path,custom_formats:[],save_format:"raw",can_edit:t.can_edit}})],1),e("div",{staticClass:"_cover--pickCover"},[t.cover_image_media?[e("div",{staticClass:"_cover--pickCover--img"},[e("MediaContent",{attrs:{file:t.cover_image_media,resolution:1600}}),e("button",{staticClass:"u-button u-button_bleuvert u-button_small _changeCoverBtn",attrs:{type:"button"},on:{click:function(n){t.show_cover_picker=!0}}},[t._v(" "+t._s(t.$t("change"))+" ")])],1)]:[e("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button"},on:{click:function(n){t.show_cover_picker=!0}}},[t._v(" "+t._s(t.$t("pick_cover"))+" ")])],t.show_cover_picker?e("MediaPicker",{attrs:{publication_path:t.publication.$path,select_mode:"single",pick_from_types:["image"]},on:{addMedias:t.pickCover,close:function(n){t.show_cover_picker=!1}}}):t._e()],2),e("div",{staticClass:"u-spacingBottom"}),e("DLabel",{attrs:{str:t.$t("text_image_layout")}}),e("SelectField2",{attrs:{field_name:"cover_layout_mode",value:t.cover_media.cover_layout_mode,path:t.cover_media.$path,hide_validation:!0,can_edit:t.can_edit,options:t.cover_layout_mode_options}})]:t._e()],2)},v=[],f=s(u,h,v,!1,null,"56ef0eea");const $=f.exports,b={props:{section:{type:Object,required:!0},index:Number,number_of_sections:Number,can_edit:Boolean},components:{},data(){return{}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{},methods:{previewContent(a){var e;const t=(e=a._main_text)==null?void 0:e.$content;return t?t.substring(0,100)+"...":!1}}};var g=function(){var t=this,e=t._self._c;return e("div",{staticClass:"u-card2 _chapterPreview"},[t.can_edit?e("div",{staticClass:"_selects"},[e("select",{staticClass:"_selects--order",attrs:{size:"small"},domProps:{value:t.index},on:{change:function(n){return t.$emit("moveSection",{old_position:t.index,new_position:+n.target.value})}}},t._l(t.number_of_sections,function(n){return e("option",{key:n-1,domProps:{value:n-1,textContent:t._s(n)}})}),0),e("div",{staticClass:"_selects--starts_on_page"},[e("SelectField2",{attrs:{field_name:"section_starts_on_page",value:t.section.section_starts_on_page||"",path:t.section.$path,size:"small",hide_validation:!0,can_edit:t.can_edit,options:[{key:"",text:t.$t("in_flow")},{key:"left",text:t.$t("next_left_page")},{key:"right",text:t.$t("next_right_page")}]}})],1)]):t._e(),e("h2",{staticClass:"_item--title"},[t.section.section_title?[t._v(" "+t._s(t.section.section_title)+" ")]:[e("i",[t._v(t._s(t.$t("untitled")))])]],2),e("div",{staticClass:"_item--content"},[t.previewContent(t.section)?e("CollaborativeEditor3",{attrs:{content:t.previewContent(t.section)}}):e("div",{staticClass:"u-instructions"},[t._v(t._s(t.$t("no_content")))])],1),e("button",{staticClass:"js--showCursor _openButton",attrs:{type:"button",title:t.$t("open")},on:{click:function(n){return t.$emit("open")}}})])},y=[],C=s(b,g,y,!1,null,"a4777c37");const w=C.exports,x={props:{publication:Object,sections:Array,opened_section_meta_filename:String,can_edit:Boolean},components:{ChapterPreview:w,SetCover:$},data(){return{}},created(){},mounted(){this.can_edit&&this.sections.length===0&&this.createSection()},beforeDestroy(){},watch:{opened_section_meta_filename(){}},computed:{is_associated_to_map(){return this.$getMapOptions},new_section_title(){let a=this.sections.length+1;const t=n=>this.$t("section")+" "+n;let e=t(a);for(;this.sections.some(n=>n.section_title===e);)a++,e=t(a);return e},opened_section(){return this.sections.find(a=>this.getFilename(a.$path)===this.opened_section_meta_filename)}},methods:{openSection(a){this.$emit("toggleSection",this.getFilename(a))},async createSection(){const a=this.new_section_title+" text.txt",{meta_filename:t}=await this.$api.uploadText({path:this.publication.$path,filename:a,content:"",additional_meta:{content_type:"markdown"}});await this.createSection2({publication:this.publication,additional_meta:{section_title:this.new_section_title,main_text_meta:t,section_starts_on_page:"right"}})},async moveSection({old_position:a,new_position:t}){let e=this.sections.map(i=>({meta_filename:this.getFilename(i.$path)}));function n(i,o,c){if(c>=i.length)for(var _=c-i.length+1;_--;)i.push(void 0);return i.splice(c,0,i.splice(o,1)[0]),i}return n(e,a,t),await this.$api.updateMeta({path:this.publication.$path,new_meta:{sections_list:e}})}}};var k=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_chaptersSummary"},[e("div",{staticClass:"_content"},[e("DLabel",{attrs:{str:t.$t("content")}}),e("transition-group",{key:"allpages",staticClass:"_allChapters",attrs:{tag:"div",name:"listComplete",appear:""}},[e("SetCover",{key:"cover",attrs:{publication:t.publication,can_edit:t.can_edit}}),t._l(t.sections,function(n,i){return e("ChapterPreview",{key:n.$path,attrs:{section:n,index:i,number_of_sections:t.sections.length,can_edit:t.can_edit},on:{open:function(o){return t.openSection(n.$path)},moveSection:t.moveSection}})}),e("div",{key:"'add'",staticClass:"_addSection"},[t.can_edit?e("EditBtn",{attrs:{btn_type:"create_chapter",is_unfolded:!0},on:{click:t.createSection}}):t._e()],1)],2)],1)])},S=[],M=s(x,k,S,!1,null,"cae17125");const F=M.exports,B={props:{chapter:Object,can_edit:Boolean},components:{},data(){return{}},created(){},mounted(){},beforeDestroy(){},watch:{"chapter._main_text.$content":{handler(a){this.listAllEmbeddedMedias(a)},deep:!0}},computed:{content_type(){var a;return((a=this.chapter._main_text)==null?void 0:a.content_type)||"html"},custom_formats(){if(this.content_type==="markdown")return[]},save_format(){return this.content_type==="html"?"html":this.content_type==="markdown"?"raw":"html"}},methods:{listAllEmbeddedMedias(a){let t=[];r.use({renderer:{image:(e,n,i)=>{const o=this.getParent(this.chapter.$path);this.getSourceMedia({source_media:{meta_filename_in_project:e},folder_path:o})&&t.push({meta_filename_in_project:e})}}}),r.parse(a),JSON.stringify(t)!==JSON.stringify(this.chapter.source_medias)&&this.$api.updateMeta({path:this.chapter.$path,new_meta:{source_medias:t}})}}};var O=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_openChapter"},[e("div",{staticClass:"_topButtons"},[e("div",[e("button",{staticClass:"u-buttonLink",attrs:{type:"button"},on:{click:function(n){return t.$emit("close")}}},[e("b-icon",{attrs:{icon:"arrow-left-short"}}),t._v(" "+t._s(t.$t("back"))+" ")],1)]),e("RemoveMenu",{on:{remove:function(n){return t.$emit("remove")}}})],1),e("div",{staticClass:"_content"},[e("div",{staticClass:"u-spacingBottom"},[e("TitleField",{attrs:{label:t.$t("section_title"),field_name:"section_title",content:t.chapter.section_title,required:!0,maxlength:40,tag:"h1",path:t.chapter.$path,can_edit:t.can_edit}})],1),t.chapter._main_text?[e("DLabel",{attrs:{str:t.$t("content")}}),e("CollaborativeEditor3",{attrs:{content:t.chapter._main_text.$content,path:t.chapter._main_text.$path,custom_formats:t.custom_formats,save_format:t.save_format,can_edit:t.can_edit,mode:"always_active"}})]:t._e()],2)])},P=[],j=s(B,O,P,!1,null,"31c3fa74");const D=j.exports,E={props:{publication:Object},components:{},data(){return{}},created(){},mounted(){(!this.style_files||this.style_files.length===0)&&this.createStyles()},beforeDestroy(){},watch:{},computed:{style_files(){var a;return(a=this.publication.$files)==null?void 0:a.filter(t=>{var e;return(e=t.$media_filename)==null?void 0:e.endsWith(".css")})}},methods:{async createStyles(){await this.$api.uploadText({path:this.publication.$path,filename:"styles.css",content:"",additional_meta:{$type:"text"}})}}};var R=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_editGraphicStyles"},t._l(t.style_files,function(n){return e("CollaborativeEditor3",{key:n.$path,attrs:{content:n.$content,path:n.$path,custom_formats:[],save_format:"raw",mode:"always_active",can_edit:!0}})}),1)},T=[],G=s(E,R,T,!1,null,"356e17c4");const I=G.exports,L={props:{publication:Object,opened_section_meta_filename:String,can_edit:Boolean},components:{Splitpanes:l,Pane:p,ChaptersSummary:F,OpenChapter:D,ViewContent:d,EditGraphicStyles:I},data(){return{show_edit_graphics:!1}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{all_chapters(){return this.getSectionsWithProps({publication:this.publication,group:"sections_list"}).map(a=>(a.main_text_meta&&(a._main_text=this.publication.$files.find(t=>t.$path.endsWith("/"+a.main_text_meta))),a))},open_chapter(){return this.opened_section_meta_filename?this.all_chapters.find(a=>a.$path.endsWith(this.opened_section_meta_filename)):!1}},methods:{async removeChapter(a){a._main_text&&await this.$api.deleteItem({path:a._main_text.$path}),await this.$api.deleteItem({path:a.$path})}}};var N=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_markdownTemplate"},[e("splitpanes",{staticClass:"_splitpanes"},[e("pane",[e("ChaptersSummary",{attrs:{publication:t.publication,sections:t.all_chapters,opened_section_meta_filename:t.opened_section_meta_filename,can_edit:t.can_edit},on:{toggleSection:function(n){return t.$emit("toggleSection",n)}}}),e("div",{staticClass:"_editGraphics"},[e("button",{staticClass:"u-button u-button_bleumarine",attrs:{type:"button"},on:{click:function(n){t.show_edit_graphics=!0}}},[t._v(" "+t._s(t.$t("styles"))+" ")])]),e("transition",{attrs:{name:"scaleInFade",mode:"in-out"}},[t.open_chapter?e("OpenChapter",{key:t.open_chapter.$path,attrs:{chapter:t.open_chapter,can_edit:t.can_edit},on:{remove:function(n){return t.removeChapter(t.open_chapter)},close:function(n){return t.$emit("toggleSection",null)}}}):t.show_edit_graphics?e("EditGraphicStyles",{attrs:{publication:t.publication},on:{close:function(n){t.show_edit_graphics=!1}}}):t._e()],1)],1),e("pane",[e("div",{staticClass:"_viewer"},[e("ViewContent",{attrs:{publication:t.publication,opened_chapter_meta_filename:t.opened_section_meta_filename,can_edit:t.can_edit},on:{openChapter:function(n){return t.$emit("toggleSection",n)}}})],1)])],1)],1)},W=[],q=s(L,N,W,!1,null,"f1205e3f");const K=q.exports;export{K as default};
