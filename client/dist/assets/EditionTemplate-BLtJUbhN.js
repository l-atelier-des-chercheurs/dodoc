import{M as y}from"./MediaPicker-CMgKJFsT.js";import{n as d,_ as S}from"../build.js";import{M as P,m as z,H as $,d as u,V as M}from"./ViewContent-nUt1Fbv1.js";/* empty css               */import{P as F}from"./PublicationSettings-DIeHMtor.js";import"./PickExistingMediastackModal-CVIn4Pjj.js";import"./DestinationCorpusSelector-D9gmIUpK.js";var E=Object.defineProperty,T=Object.defineProperties,O=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,x=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable,g=(i,e,t)=>e in i?E(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,D=(i,e)=>{for(var t in e||(e={}))x.call(e,t)&&g(i,t,e[t]);if(h)for(var t of h(e))k.call(e,t)&&g(i,t,e[t]);return i},R=(i,e)=>T(i,O(e)),j=(i,e)=>{var t={};for(var s in i)x.call(i,s)&&e.indexOf(s)<0&&(t[s]=i[s]);if(i!=null&&h)for(var s of h(i))e.indexOf(s)<0&&k.call(i,s)&&(t[s]=i[s]);return t};function C(i,e,t,s,n,a,o,c){var r=typeof i=="function"?i.options:i;e&&(r.render=e,r.staticRenderFns=t,r._compiled=!0);var l;if(n&&(l=n),l)if(r.functional){r._injectStyles=l;var _=r.render;r.render=function(f,v){return l.call(v),_(f,v)}}else{var p=r.beforeCreate;r.beforeCreate=p?[].concat(p,l):[l]}return{exports:i,options:r}}const B={name:"splitpanes",props:{horizontal:{type:Boolean},pushOtherPanes:{type:Boolean,default:!0},dblClickSplitter:{type:Boolean,default:!0},rtl:{type:Boolean,default:!1},firstSplitter:{type:Boolean}},provide(){return{requestUpdate:this.requestUpdate,onPaneAdd:this.onPaneAdd,onPaneRemove:this.onPaneRemove,onPaneClick:this.onPaneClick}},data:()=>({container:null,ready:!1,panes:[],touch:{mouseDown:!1,dragging:!1,activeSplitter:null},splitterTaps:{splitter:null,timeoutId:null}}),computed:{panesCount(){return this.panes.length},indexedPanes(){return this.panes.reduce((i,e)=>(i[e.id]=e)&&i,{})}},methods:{updatePaneComponents(){this.panes.forEach(i=>{i.update&&i.update({[this.horizontal?"height":"width"]:`${this.indexedPanes[i.id].size}%`})})},bindEvents(){document.addEventListener("mousemove",this.onMouseMove,{passive:!1}),document.addEventListener("mouseup",this.onMouseUp),"ontouchstart"in window&&(document.addEventListener("touchmove",this.onMouseMove,{passive:!1}),document.addEventListener("touchend",this.onMouseUp))},unbindEvents(){document.removeEventListener("mousemove",this.onMouseMove,{passive:!1}),document.removeEventListener("mouseup",this.onMouseUp),"ontouchstart"in window&&(document.removeEventListener("touchmove",this.onMouseMove,{passive:!1}),document.removeEventListener("touchend",this.onMouseUp))},onMouseDown(i,e){this.bindEvents(),this.touch.mouseDown=!0,this.touch.activeSplitter=e},onMouseMove(i){this.touch.mouseDown&&(i.preventDefault(),this.touch.dragging=!0,this.calculatePanesSize(this.getCurrentMouseDrag(i)),this.$emit("resize",this.panes.map(e=>({min:e.min,max:e.max,size:e.size}))))},onMouseUp(){this.touch.dragging&&this.$emit("resized",this.panes.map(i=>({min:i.min,max:i.max,size:i.size}))),this.touch.mouseDown=!1,setTimeout(()=>{this.touch.dragging=!1,this.unbindEvents()},100)},onSplitterClick(i,e){"ontouchstart"in window&&(i.preventDefault(),this.dblClickSplitter&&(this.splitterTaps.splitter===e?(clearTimeout(this.splitterTaps.timeoutId),this.splitterTaps.timeoutId=null,this.onSplitterDblClick(i,e),this.splitterTaps.splitter=null):(this.splitterTaps.splitter=e,this.splitterTaps.timeoutId=setTimeout(()=>{this.splitterTaps.splitter=null},500)))),this.touch.dragging||this.$emit("splitter-click",this.panes[e])},onSplitterDblClick(i,e){let t=0;this.panes=this.panes.map((s,n)=>(s.size=n===e?s.max:s.min,n!==e&&(t+=s.min),s)),this.panes[e].size-=t,this.$emit("pane-maximize",this.panes[e])},onPaneClick(i,e){this.$emit("pane-click",this.indexedPanes[e])},getCurrentMouseDrag(i){const e=this.container.getBoundingClientRect(),{clientX:t,clientY:s}="ontouchstart"in window&&i.touches?i.touches[0]:i;return{x:t-e.left,y:s-e.top}},getCurrentDragPercentage(i){i=i[this.horizontal?"y":"x"];const e=this.container[this.horizontal?"clientHeight":"clientWidth"];return this.rtl&&!this.horizontal&&(i=e-i),i*100/e},calculatePanesSize(i){const e=this.touch.activeSplitter;let t={prevPanesSize:this.sumPrevPanesSize(e),nextPanesSize:this.sumNextPanesSize(e),prevReachedMinPanes:0,nextReachedMinPanes:0};const s=0+(this.pushOtherPanes?0:t.prevPanesSize),n=100-(this.pushOtherPanes?0:t.nextPanesSize),a=Math.max(Math.min(this.getCurrentDragPercentage(i),n),s);let o=[e,e+1],c=this.panes[o[0]]||null,r=this.panes[o[1]]||null;const l=c.max<100&&a>=c.max+t.prevPanesSize,_=r.max<100&&a<=100-(r.max+this.sumNextPanesSize(e+1));if(l||_){l?(c.size=c.max,r.size=Math.max(100-c.max-t.prevPanesSize-t.nextPanesSize,0)):(c.size=Math.max(100-r.max-t.prevPanesSize-this.sumNextPanesSize(e+1),0),r.size=r.max);return}if(this.pushOtherPanes){const p=this.doPushOtherPanes(t,a);if(!p)return;({sums:t,panesToResize:o}=p),c=this.panes[o[0]]||null,r=this.panes[o[1]]||null}c!==null&&(c.size=Math.min(Math.max(a-t.prevPanesSize-t.prevReachedMinPanes,c.min),c.max)),r!==null&&(r.size=Math.min(Math.max(100-a-t.nextPanesSize-t.nextReachedMinPanes,r.min),r.max))},doPushOtherPanes(i,e){const t=this.touch.activeSplitter,s=[t,t+1];return e<i.prevPanesSize+this.panes[s[0]].min&&(s[0]=this.findPrevExpandedPane(t).index,i.prevReachedMinPanes=0,s[0]<t&&this.panes.forEach((n,a)=>{a>s[0]&&a<=t&&(n.size=n.min,i.prevReachedMinPanes+=n.min)}),i.prevPanesSize=this.sumPrevPanesSize(s[0]),s[0]===void 0)?(i.prevReachedMinPanes=0,this.panes[0].size=this.panes[0].min,this.panes.forEach((n,a)=>{a>0&&a<=t&&(n.size=n.min,i.prevReachedMinPanes+=n.min)}),this.panes[s[1]].size=100-i.prevReachedMinPanes-this.panes[0].min-i.prevPanesSize-i.nextPanesSize,null):e>100-i.nextPanesSize-this.panes[s[1]].min&&(s[1]=this.findNextExpandedPane(t).index,i.nextReachedMinPanes=0,s[1]>t+1&&this.panes.forEach((n,a)=>{a>t&&a<s[1]&&(n.size=n.min,i.nextReachedMinPanes+=n.min)}),i.nextPanesSize=this.sumNextPanesSize(s[1]-1),s[1]===void 0)?(i.nextReachedMinPanes=0,this.panes[this.panesCount-1].size=this.panes[this.panesCount-1].min,this.panes.forEach((n,a)=>{a<this.panesCount-1&&a>=t+1&&(n.size=n.min,i.nextReachedMinPanes+=n.min)}),this.panes[s[0]].size=100-i.prevPanesSize-i.nextReachedMinPanes-this.panes[this.panesCount-1].min-i.nextPanesSize,null):{sums:i,panesToResize:s}},sumPrevPanesSize(i){return this.panes.reduce((e,t,s)=>e+(s<i?t.size:0),0)},sumNextPanesSize(i){return this.panes.reduce((e,t,s)=>e+(s>i+1?t.size:0),0)},findPrevExpandedPane(i){return[...this.panes].reverse().find(t=>t.index<i&&t.size>t.min)||{}},findNextExpandedPane(i){return this.panes.find(t=>t.index>i+1&&t.size>t.min)||{}},checkSplitpanesNodes(){Array.from(this.container.children).forEach(e=>{const t=e.classList.contains("splitpanes__pane"),s=e.classList.contains("splitpanes__splitter");if(!t&&!s){e.parentNode.removeChild(e),console.warn("Splitpanes: Only <pane> elements are allowed at the root of <splitpanes>. One of your DOM nodes was removed.");return}})},addSplitter(i,e,t=!1){const s=i-1,n=document.createElement("div");n.classList.add("splitpanes__splitter"),t||(n.onmousedown=a=>this.onMouseDown(a,s),typeof window<"u"&&"ontouchstart"in window&&(n.ontouchstart=a=>this.onMouseDown(a,s)),n.onclick=a=>this.onSplitterClick(a,s+1)),this.dblClickSplitter&&(n.ondblclick=a=>this.onSplitterDblClick(a,s+1)),e.parentNode.insertBefore(n,e)},removeSplitter(i){i.onmousedown=void 0,i.onclick=void 0,i.ondblclick=void 0,i.parentNode.removeChild(i)},redoSplitters(){const i=Array.from(this.container.children);i.forEach(t=>{t.className.includes("splitpanes__splitter")&&this.removeSplitter(t)});let e=0;i.forEach(t=>{t.className.includes("splitpanes__pane")&&(!e&&this.firstSplitter?this.addSplitter(e,t,!0):e&&this.addSplitter(e,t),e++)})},requestUpdate(i){var e=i,{target:t}=e,s=j(e,["target"]);const n=this.indexedPanes[t._uid];Object.entries(s).forEach(([a,o])=>n[a]=o)},onPaneAdd(i){let e=-1;Array.from(i.$el.parentNode.children).some(n=>(n.className.includes("splitpanes__pane")&&e++,n===i.$el));const t=parseFloat(i.minSize),s=parseFloat(i.maxSize);this.panes.splice(e,0,{id:i._uid,index:e,min:isNaN(t)?0:t,max:isNaN(s)?100:s,size:i.size===null?null:parseFloat(i.size),givenSize:i.size,update:i.update}),this.panes.forEach((n,a)=>n.index=a),this.ready&&this.$nextTick(()=>{this.redoSplitters(),this.resetPaneSizes({addedPane:this.panes[e]}),this.$emit("pane-add",{index:e,panes:this.panes.map(n=>({min:n.min,max:n.max,size:n.size}))})})},onPaneRemove(i){const e=this.panes.findIndex(s=>s.id===i._uid),t=this.panes.splice(e,1)[0];this.panes.forEach((s,n)=>s.index=n),this.$nextTick(()=>{this.redoSplitters(),this.resetPaneSizes({removedPane:R(D({},t),{index:e})}),this.$emit("pane-remove",{removed:t,panes:this.panes.map(s=>({min:s.min,max:s.max,size:s.size}))})})},resetPaneSizes(i={}){!i.addedPane&&!i.removedPane?this.initialPanesSizing():this.panes.some(e=>e.givenSize!==null||e.min||e.max<100)?this.equalizeAfterAddOrRemove(i):this.equalize(),this.ready&&this.$emit("resized",this.panes.map(e=>({min:e.min,max:e.max,size:e.size})))},equalize(){const i=100/this.panesCount;let e=0,t=[],s=[];this.panes.forEach(n=>{n.size=Math.max(Math.min(i,n.max),n.min),e-=n.size,n.size>=n.max&&t.push(n.id),n.size<=n.min&&s.push(n.id)}),e>.1&&this.readjustSizes(e,t,s)},initialPanesSizing(){100/this.panesCount;let i=100,e=[],t=[],s=0;this.panes.forEach(a=>{i-=a.size,a.size!==null&&s++,a.size>=a.max&&e.push(a.id),a.size<=a.min&&t.push(a.id)});let n=100;i>.1&&(this.panes.forEach(a=>{a.size===null&&(a.size=Math.max(Math.min(i/(this.panesCount-s),a.max),a.min)),n-=a.size}),n>.1&&this.readjustSizes(i,e,t))},equalizeAfterAddOrRemove({addedPane:i,removedPane:e}={}){let t=100/this.panesCount,s=0,n=[],a=[];i&&i.givenSize!==null&&(t=(100-i.givenSize)/(this.panesCount-1)),this.panes.forEach(o=>{s-=o.size,o.size>=o.max&&n.push(o.id),o.size<=o.min&&a.push(o.id)}),!(Math.abs(s)<.1)&&(this.panes.forEach(o=>{i&&i.givenSize!==null&&i.id===o.id||(o.size=Math.max(Math.min(t,o.max),o.min)),s-=o.size,o.size>=o.max&&n.push(o.id),o.size<=o.min&&a.push(o.id)}),s>.1&&this.readjustSizes(s,n,a))},readjustSizes(i,e,t){let s;i>0?s=i/(this.panesCount-e.length):s=i/(this.panesCount-t.length),this.panes.forEach((n,a)=>{if(i>0&&!e.includes(n.id)){const o=Math.max(Math.min(n.size+s,n.max),n.min),c=o-n.size;i-=c,n.size=o}else if(!t.includes(n.id)){const o=Math.max(Math.min(n.size+s,n.max),n.min),c=o-n.size;i-=c,n.size=o}n.update({[this.horizontal?"height":"width"]:`${this.indexedPanes[n.id].size}%`})}),Math.abs(i)>.1&&this.$nextTick(()=>{this.ready&&console.warn("Splitpanes: Could not resize panes correctly due to their constraints.")})}},watch:{panes:{deep:!0,immediate:!1,handler(){this.updatePaneComponents()}},horizontal(){this.updatePaneComponents()},firstSplitter(){this.redoSplitters()},dblClickSplitter(i){[...this.container.querySelectorAll(".splitpanes__splitter")].forEach((t,s)=>{t.ondblclick=i?n=>this.onSplitterDblClick(n,s):void 0})}},beforeDestroy(){this.ready=!1},mounted(){this.container=this.$refs.container,this.checkSplitpanesNodes(),this.redoSplitters(),this.resetPaneSizes(),this.$emit("ready"),this.ready=!0},render(i){return i("div",{ref:"container",class:["splitpanes",`splitpanes--${this.horizontal?"horizontal":"vertical"}`,{"splitpanes--dragging":this.touch.dragging}]},this.$slots.default)}};let N,L;const w={};var A=C(B,N,L,!1,q);function q(i){for(let e in w)this[e]=w[e]}var I=function(){return A.exports}(),H=function(){var i=this,e=i.$createElement,t=i._self._c||e;return t("div",{staticClass:"splitpanes__pane",style:i.style,on:{click:function(s){return i.onPaneClick(s,i._uid)}}},[i._t("default")],2)},V=[];const U={name:"pane",inject:["requestUpdate","onPaneAdd","onPaneRemove","onPaneClick"],props:{size:{type:[Number,String],default:null},minSize:{type:[Number,String],default:0},maxSize:{type:[Number,String],default:100}},data:()=>({style:{}}),mounted(){this.onPaneAdd(this)},beforeDestroy(){this.onPaneRemove(this)},methods:{update(i){this.style=i}},computed:{sizeNumber(){return this.size||this.size===0?parseFloat(this.size):null},minSizeNumber(){return parseFloat(this.minSize)},maxSizeNumber(){return parseFloat(this.maxSize)}},watch:{sizeNumber(i){this.requestUpdate({target:this,size:i})},minSizeNumber(i){this.requestUpdate({target:this,min:i})},maxSizeNumber(i){this.requestUpdate({target:this,max:i})}}},b={};var W=C(U,H,V,!1,G);function G(i){for(let e in b)this[e]=b[e]}var J=function(){return W.exports}();const X={props:{publication:{type:Object,required:!0}},components:{MediaPicker:y},data(){return{show_cover_picker:!1,cover_layout_mode_options:[{key:"",text:this.$t("normal")},{key:"full_page",text:this.$t("full_page")},{key:"text_top_image_down",text:this.$t("text_top_image_down")},{key:"image_top_text_down",text:this.$t("image_top_text_down")}]}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{cover_media(){var i;return(i=this.publication.$files)==null?void 0:i.find(e=>e.cover_type==="front")},cover_image_media(){var t,s;const i=(s=(t=this.cover_media)==null?void 0:t.source_medias)==null?void 0:s[0];if(!i)return!1;const e=this.getSourceMedia({source_media:i,folder_path:this.publication.$path});return e||!1}},methods:{async createCover(){const i="frontcover.txt",{meta_filename:e}=await this.$api.uploadText({path:this.publication.$path,filename:i,content:this.$t("title"),additional_meta:{cover_type:"front"}})},async removeCover(){this.$api.deleteItem({path:this.cover_media.$path})},async pickCover(i){const e=i[0],t=this.$root.publication_include_mode,s=await this.prepareMediaForPublication({path_to_source_media_meta:e.$path,publication_path:this.publication.$path,import_mode:t});this.$api.updateMeta({path:this.cover_media.$path,new_meta:{source_medias:[s]}})}}};var Y=function(){var e=this,t=e._self._c;return t("div",{staticClass:"_cover"},[e.cover_media?e._e():t("div",{},[t("DLabel",{attrs:{str:e.$t("cover")}}),t("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button"},on:{click:e.createCover}},[e._v(" "+e._s(e.$t("create"))+" ")])],1),e.cover_media?[t("div",{staticClass:"u-spacingBottom"},[t("CollaborativeEditor3",{attrs:{label:e.$t("title"),content:e.cover_media.$content,path:e.cover_media.$path,custom_formats:[],save_format:"raw",can_edit:!0}})],1),t("div",{staticClass:"_cover--pickCover"},[e.cover_image_media?[t("div",{staticClass:"_cover--pickCover--img"},[t("MediaContent",{attrs:{file:e.cover_image_media,resolution:1600}}),t("button",{staticClass:"u-button u-button_bleuvert u-button_small _changeCoverBtn",attrs:{type:"button"},on:{click:function(s){e.show_cover_picker=!0}}},[e._v(" "+e._s(e.$t("change"))+" ")])],1)]:[t("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button"},on:{click:function(s){e.show_cover_picker=!0}}},[e._v(" "+e._s(e.$t("pick_cover"))+" ")])],e.show_cover_picker?t("MediaPicker",{attrs:{publication_path:e.publication.$path,select_mode:"single",pick_from_types:["image"]},on:{pickMedias:e.pickCover,close:function(s){e.show_cover_picker=!1}}}):e._e()],2),t("div",{staticClass:"u-spacingBottom"}),t("DLabel",{attrs:{str:e.$t("text_image_layout")}}),t("SelectField2",{attrs:{field_name:"cover_layout_mode",value:e.cover_media.cover_layout_mode,path:e.cover_media.$path,hide_validation:!0,can_edit:!0,options:e.cover_layout_mode_options}}),t("RemoveMenu",{on:{remove:e.removeCover}})]:e._e()],2)},K=[],Q=d(X,Y,K,!1,null,"5e70641e");const Z=Q.exports,ee={props:{section:{type:Object,required:!0},index:Number,number_of_sections:Number,view_mode:String,chapters_positions:Array,pages_positions:Object},components:{},data(){return{}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{gallery_medias(){var i;return this.section.section_type!=="gallery"||!this.section.source_medias?[]:(i=this.section.source_medias)==null?void 0:i.map(e=>this.getSourceMedia({source_media:e,folder_path:this.getParent(this.section.$path)}))}},methods:{previewContent(i){var t;const e=(t=i._main_text)==null?void 0:t.$content;return e?e.substring(0,200)+"...":!1}}};var te=function(){var s;var e=this,t=e._self._c;return t("div",{staticClass:"_chapterPreview"},[t("div",{staticClass:"_selects"},[t("select",{staticClass:"_selects--order",attrs:{size:"small"},domProps:{value:e.index},on:{change:function(n){return e.$emit("moveSection",{old_position:e.index,new_position:+n.target.value})}}},e._l(e.number_of_sections,function(n){return t("option",{key:n-1,domProps:{value:n-1,textContent:e._s(n)}})}),0),t("transition",{attrs:{name:"fade",mode:"out-in"}},[e.view_mode==="book"&&((s=e.pages_positions)!=null&&s.first_page)?t("div",{key:e.pages_positions.first_page,staticClass:"_selects--pageRange"},[e._v(" p."+e._s(e.pages_positions.first_page)+" "),e.pages_positions.first_page!==e.pages_positions.last_page?[t("b-icon",{attrs:{icon:"arrow-right-short"}}),e._v(" p."+e._s(e.pages_positions.last_page)+" ")]:e._e()],2):e._e()])],1),t("div",{staticClass:"u-card2 _chapterPreview--card"},[t("div",{staticClass:"_topRow"},[t("h2",{staticClass:"_item--title"},[e.section.section_title?[e._v(" "+e._s(e.section.section_title)+" ")]:[t("i",[e._v(e._s(e.$t("untitled")))])],t("small",{staticClass:"_item--title--icon"},[e.section.section_type==="text"?t("b-icon",{attrs:{icon:"markdown"}}):e.section.section_type==="gallery"?t("b-icon",{attrs:{icon:"image"}}):e._e()],1)],2)]),t("div",{staticClass:"_item--content"},[e.section.section_type==="text"&&e.previewContent(e.section)?t("div",{staticClass:"_item--content--text"},[t("CollaborativeEditor3",{attrs:{content:e.previewContent(e.section)}})],1):e.section.section_type==="gallery"&&e.gallery_medias.length>0?t("div",{staticClass:"_item--content--gallery"},e._l(e.gallery_medias,function(n){return t("div",{key:n.$path},[t("MediaContent",{attrs:{file:n}})],1)}),0):t("div",{staticClass:"u-instructions"},[e._v(e._s(e.$t("no_content")))])]),t("button",{staticClass:"_openButton",attrs:{type:"button",title:e.$t("open")},on:{click:function(n){return e.$emit("open")}}})])])},ie=[],se=d(ee,te,ie,!1,null,"05da1b7b");const ne=se.exports,ae={props:{publication:Object,sections:Array,opened_section_meta_filename:String,view_mode:String,chapters_positions:Object},components:{ChapterPreview:ne,SetCover:Z},i18n:{messages:{fr:{new_section:"Nouveau chapitre"},en:{new_section:"New chapter"}}},data(){return{}},created(){},mounted(){},beforeDestroy(){},watch:{opened_section_meta_filename(){}},computed:{is_associated_to_map(){return this.$getMapOptions},new_section_index(){let i=this.sections.length+1;const e=s=>" "+s;let t=e(i);for(;this.sections.some(s=>s.section_title.endsWith(t));)i++,t=e(i);return t},opened_section(){return this.sections.find(i=>this.getFilename(i.$path)===this.opened_section_meta_filename)}},methods:{openSection(i){this.$emit("toggleSection",this.getFilename(i))},async createSection({type:i="text"}={}){let e={section_starts_on_page:"right"};if(i==="text"){const s=this.new_section_title+" text.txt",{meta_filename:n}=await this.$api.uploadText({path:this.publication.$path,filename:s,content:"",additional_meta:{content_type:"markdown"}});e.section_title=this.$t("section")+" "+this.new_section_index,e.section_type="text",e.main_text_meta=n}else i==="gallery"?(e.section_title=this.$t("gallery")+" "+this.new_section_index,e.section_type="gallery"):i==="story"&&(e.section_title=this.$t("story")+" "+this.new_section_index,e.section_type="story");const t=await this.createSection2({publication:this.publication,additional_meta:e});setTimeout(()=>{this.$emit("toggleSection",t)},100)},async moveSection({old_position:i,new_position:e}){const t=this.getFilename(this.sections[i].$path);let s=this.sections.map(a=>({meta_filename:this.getFilename(a.$path)}));function n(a,o,c){if(c>=a.length)for(var r=c-a.length+1;r--;)a.push(void 0);return a.splice(c,0,a.splice(o,1)[0]),a}n(s,i,e),await this.$api.updateMeta({path:this.publication.$path,new_meta:{sections_list:s}}),setTimeout(()=>{this.$eventHub.$emit("edition.zoomToSection",t)},500)},getPagesPositions(i){const e=this.getFilename(i);return this.chapters_positions[e]}}};var oe=function(){var e=this,t=e._self._c;return t("div",{staticClass:"_chaptersSummary"},[t("div",{staticClass:"_content"},[t("transition-group",{key:"allpages",staticClass:"_allChapters",attrs:{tag:"div",name:"listComplete",appear:""}},[t("SetCover",{key:"cover",attrs:{publication:e.publication}}),e._l(e.sections,function(s,n){return t("ChapterPreview",{key:s.$path,attrs:{section:s,index:n,number_of_sections:e.sections.length,view_mode:e.view_mode,pages_positions:e.getPagesPositions(s.$path)},on:{open:function(a){return e.openSection(s.$path)},moveSection:e.moveSection,remove:function(a){return e.$emit("removeChapter",s)}}})}),t("div",{key:"'add'",staticClass:"_addSection"},[t("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button"},on:{click:function(s){return e.createSection({type:"text"})}}},[t("b-icon",{attrs:{icon:"plus"}}),e._v(" "+e._s(e.$t("new_section"))+" ")],1),e._e(),e._e()])],2)],1)])},re=[],ce=d(ae,oe,re,!1,null,"e5c799e4");const le=ce.exports,_e={name:"PickMediaForMarkdown",components:{MediaPicker:y},props:{publication_path:String},data(){return{show_media_picker:!1,medias_were_picked:!1,isCopied:!1,pick_medias_text:""}},methods:{async pickMedias(i){this.medias_were_picked=!0;let e=[];for(const t of i){const s=this.$root.publication_include_mode,n=await this.prepareMediaForPublication({path_to_source_media_meta:t.$path,publication_path:this.publication_path,import_mode:s});n.$type=t.$type,n.caption=t.caption,e.push(n)}this.pick_medias_text=this.makeStringFromMedias(e)},makeStringFromMedias(i){let e=[];return i.map(t=>{let s="(",n;t.hasOwnProperty("meta_filename_in_project")?n="../"+t.meta_filename_in_project:t.hasOwnProperty("meta_filename")&&(n="./"+t.meta_filename);let a;if(t.$type==="image")a="image";else if(t.$type==="video")a="video";else if(t.$type==="audio")a="audio";else throw new Error("Unknown media type");if(s+=`${a}: ${n}`,t.caption){const o=this.turnHtmlToMarkdown(t.caption);s+=` caption: ${o}`}s+=")",e.push(s)}),e.join(" ")},turnHtmlToMarkdown(i){const e=document.createElement("div");e.innerHTML=i;let t="";const s=e.querySelectorAll("p");return s.forEach((n,a)=>{let o=n.textContent;n.querySelectorAll("a").forEach(r=>{const l=r.textContent,_=r.getAttribute("href");if(_){const p=`[${l}](${_})`;o=o.replace(l,p)}}),t+=o+(a<s.length-1?`
`:"")}),t},copyToClipboard(){this.isCopied=!1;var i=this.$refs.urlToCopy;i.select(),i.setSelectionRange(0,99999),navigator.clipboard.writeText(i.value),this.isCopied=!0},closePickModal(){this.medias_were_picked=!1,this.isCopied=!1,this.$emit("close")},insertToText(){this.$emit("insertToText",this.pick_medias_text),this.closePickModal()}}};var pe=function(){var e=this,t=e._self._c;return t("div",{staticClass:"pick-media-for-markdown"},[t("BaseModal2",{attrs:{title:e.$t("add_media")},on:{close:e.closePickModal},scopedSlots:e._u([e.medias_were_picked?{key:"footer",fn:function(){return[t("div"),t("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:e.insertToText}},[e._v(" "+e._s(e.$t("add"))+" ")])]},proxy:!0}:null],null,!0)},[e.pick_medias_text?e._e():t("div",{staticClass:"u-spacingBottom"},[e._v(" "+e._s(e.$t("from_project"))+" "),t("b-icon",{attrs:{icon:"arrow-right"}}),e._v("  "),t("button",{staticClass:"u-button u-button_orange",attrs:{type:"button"},on:{click:function(s){e.show_media_picker=!0}}},[t("b-icon",{staticStyle:{"font-size":"var(--icon-size)"},attrs:{icon:"image"}}),e._v(" "+e._s(e.$t("import"))+" ")],1)],1),e.show_media_picker?t("MediaPicker",{attrs:{publication_path:e.publication_path,select_mode:"multiple",pick_from_types:["image","video","audio"]},on:{pickMedias:e.pickMedias,close:function(s){e.show_media_picker=!1}}}):e._e(),e.pick_medias_text?t("div",{staticClass:"u-spacingBottom u-inputGroup"},[t("textarea",{directives:[{name:"model",rawName:"v-model",value:e.pick_medias_text,expression:"pick_medias_text"}],ref:"urlToCopy",staticClass:"_textField",domProps:{value:e.pick_medias_text},on:{input:function(s){s.target.composing||(e.pick_medias_text=s.target.value)}}}),e._v(" "),t("button",{staticClass:"u-button u-button_icon u-suffix _clipboardBtn",attrs:{type:"button"},on:{click:e.copyToClipboard}},[e.isCopied?t("b-icon",{attrs:{icon:"clipboard-check"}}):t("b-icon",{attrs:{icon:"clipboard"}})],1)]):t("div",{staticClass:"u-spacingBottom"},[t("hr"),e._v(" "+e._s(e.$t("multisupport_embed_img_instr"))+" "),t("ul",[t("li",[t("code",[e._v("(image: https://www.example.com/url-vers-l-image.jpeg) ")])]),t("li",[t("code",[e._v("(video: https://www.example.com/url-vers-la-video.mp4) ")])]),t("li",[t("code",[e._v("(audio: https://www.example.com/url-vers-la-musique.mp3) ")])]),t("li",[t("code",[e._v("(embed: https://peertube.fr/w/wB6M6CHdfpWXpozVnqjbde) ")])]),t("li",[t("code",[e._v("(embed: https://www.youtube.com/watch?v=Bn6zdyCAwJs) ")])]),t("li",[t("code",[e._v("(embed: https://scratch.mit.edu/projects/1061783643) ")])])])]),t("DetailsPane",{attrs:{header:e.$t("advanced_options"),icon:"rulers",has_items:!1}},[t("div",{staticClass:"u-spacingBottom"},[e._v(" "+e._s(e.$t("attributes_for_embeds"))+" "),t("ul",[t("li",[t("code",[e._v("caption: Ma légende")])]),t("li",[t("code",[e._v("class: nomDeLaClasse")])]),t("li",[t("code",[e._v("float: left")])]),t("li",[t("code",[e._v("float: right")])])])]),t("div",[e._v(" "+e._s(e.$t("for_example"))+" "),t("div",[t("code",[e._v("(embed: https://peertube.fr/w/wB6M6CHdfpWXpozVnqjbde caption: Voici une vidéo de PeerTube class: maClass)")])])])]),t("div",{staticClass:"u-spacingBottom"}),e.medias_were_picked?t("div",{staticClass:"u-instructions"},[e._v(" "+e._s(e.$t("copy_paste_to_include_media_or_click_to_add_at_cursor"))+" ")]):e._e()],1)],1)},de=[],ue=d(_e,pe,de,!1,null,"e31f5c55");const he=ue.exports,me={props:{chapter:Object,chapters:Array,prev_section:Object,next_section:Object,publication:Object,chapter_position:Object,view_mode:String},components:{PickMediaForMarkdown:he,MediaPicker:y,SingleSection:()=>S(()=>import("./SingleSection-DeReUNgz.js"),[])},data(){return{show_media_picker:!1}},i18n:{messages:{fr:{starts_on_page:"Commence sur la page"},en:{starts_on_page:"Starts on page"}}},created(){},mounted(){},beforeDestroy(){},watch:{main_text_content:{handler(i){i&&this.listAllEmbeddedMedias(i)},deep:!0}},computed:{content_type(){var i;return((i=this.chapter._main_text)==null?void 0:i.content_type)||"html"},custom_formats(){if(this.content_type==="markdown")return[]},save_format(){return this.content_type==="html"?"html":this.content_type==="markdown"?"raw":"html"},main_text_content(){var i;return(i=this.chapter._main_text)==null?void 0:i.$content},gallery_medias(){const i=[];if(this.chapter.section_type!=="gallery"||!this.chapter.source_medias)return[];for(const e of this.chapter.source_medias){const t=this.getParent(this.chapter.$path),s=this.getSourceMedia({source_media:e,folder_path:t});s&&i.push(s)}return i},starts_on_page_options(){return this.chapter.section_type==="gallery"?[{key:"page",text:this.$t("next_page")},{key:"left",text:this.$t("next_left_page")},{key:"right",text:this.$t("next_right_page")}]:[{key:"",text:this.$t("in_flow")},{key:"page",text:this.$t("next_page")},{key:"left",text:this.$t("next_left_page")},{key:"right",text:this.$t("next_right_page")}]}},methods:{listAllEmbeddedMedias(i){let e=[];const t=new P;t.use(z,{getMediaSrc:a=>{const o=this.getParent(this.chapter.$path);let c=this.transformMediaSrc(a);return this.getSourceMedia({source_media:c,folder_path:o})},vue_instance:this});const s=t.renderer.rules.image||function(a,o,c,r,l){return l.renderToken(a,o,c)};t.renderer.rules.image=(a,o,c,r,l)=>{const _=a[o],p=_.attrIndex("src");if(p>=0){const m=_.attrs[p][1],f=this.getParent(this.chapter.$path);this.getSourceMedia({source_media:{meta_filename_in_project:m},folder_path:f})&&e.push({meta_filename_in_project:m})}return s(a,o,c,r,l)};const n=t.renderer.rules.csc;t.renderer.rules.csc=(a,o)=>{const c=a[o];if(["image","video","audio"].includes(c.tag)&&c.content){const r=c.content,l=this.getParent(this.chapter.$path),_=this.transformMediaSrc(r);this.getSourceMedia({source_media:_,folder_path:l})&&e.push(_)}return n?n(a,o):""},t.render(i),e=e.filter((a,o,c)=>o===c.findIndex(r=>r.meta_filename_in_project===a.meta_filename_in_project||r.meta_filename===a.meta_filename)),JSON.stringify(e)!==JSON.stringify(this.chapter.source_medias)&&this.$api.updateMeta({path:this.chapter.$path,new_meta:{source_medias:e}})},closePickModal(){this.show_media_picker=!1},insertToText(i){const e=this.$refs.collaborativeEditor;e&&e.insertAtCursor(i)},transformMediaSrc(i){return i.startsWith("./")?{meta_filename:i.substring(2)}:i.startsWith("../")?{meta_filename_in_project:i.substring(3)}:{meta_filename_in_project:i}},async pickMediasForGallery(i){const e=[];for(const n of i){const a=this.$root.publication_include_mode,o=await this.prepareMediaForPublication({path_to_source_media_meta:n.$path,publication_path:this.publication.$path,import_mode:a});e.push(o)}const s=[...this.chapter.source_medias||[],...e];this.$api.updateMeta({path:this.chapter.$path,new_meta:{source_medias:s}})},removeMedia(i){const e=this.chapter.source_medias.filter(t=>t.meta_filename_in_project!==this.getFilename(i.$path));this.$api.updateMeta({path:this.chapter.$path,new_meta:{source_medias:e}})}}};var fe=function(){var s;var e=this,t=e._self._c;return t("div",{staticClass:"_openChapter"},[t("div",{staticClass:"_navBtns"},[t("div",{staticClass:"_navBtns--content"},[t("div",[e.prev_section?t("button",{staticClass:"u-linkList",attrs:{type:"button"},on:{click:function(n){return e.$emit("prev")}}},[t("b-icon",{attrs:{icon:"arrow-left-short"}}),t("span",[e._v(" "+e._s(e.prev_section.section_title)+" ")])],1):e._e()]),t("div",[t("button",{staticClass:"u-linkList",attrs:{type:"button"},on:{click:function(n){return e.$emit("close")}}},[t("b-icon",{attrs:{icon:"x-circle",label:e.$t("close")}}),e._v(" "+e._s(e.$t("close"))+" ")],1)]),t("div",[e.next_section?t("button",{staticClass:"u-linkList",attrs:{type:"button"},on:{click:function(n){return e.$emit("next")}}},[t("span",[e._v(" "+e._s(e.next_section.section_title)+" ")]),t("b-icon",{attrs:{icon:"arrow-right-short"}})],1):e._e()])])]),t("div",{staticClass:"_openChapter--content"},[t("div",{staticClass:"_topButtons"},[t("TitleField",{attrs:{field_name:"section_title",content:e.chapter.section_title,maxlength:100,tag:"h1",path:e.chapter.$path,can_edit:!0}}),t("DropDown",{attrs:{right:!0,show_label:!1}},[t("RemoveMenu",{on:{remove:function(n){return e.$emit("remove")}}})],1)],1),t("div",{staticClass:"_infos"},[e._e(),t("transition",{attrs:{name:"fade",mode:"out-in"}},[e.view_mode==="book"&&((s=e.chapter_position)!=null&&s.first_page)?t("div",[t("div",{key:e.chapter_position.first_page,staticClass:"_selects--pageRange"},[e._v(" p."+e._s(e.chapter_position.first_page)+" "),e.chapter_position.first_page!==e.chapter_position.last_page?[t("b-icon",{attrs:{icon:"arrow-right-short"}}),e._v(" p."+e._s(e.chapter_position.last_page)+" ")]:e._e()],2)]):e._e()])],1),e.chapter.section_type==="text"?t("fieldset",{staticClass:"_text_image_layout"},[t("legend",[e._v(e._s(e.$t("text_image_layout")))]),t("div",{staticClass:"_colCount"},[t("DLabel",{attrs:{str:e.$t("column_count")}}),t("div",{},[t("SelectField2",{attrs:{field_name:"column_count",value:e.chapter.column_count||1,path:e.chapter.$path,size:"small",hide_validation:!0,can_edit:!0,options:[{key:1,text:"1"},{key:2,text:"2"},{key:3,text:"3"}]}})],1)],1),e.view_mode==="book"?t("div",{staticClass:"_selects--starts_on_page"},[t("DLabel",{attrs:{str:e.$t("starts_on_page")}}),t("SelectField2",{attrs:{field_name:"section_starts_on_page",value:e.chapter.section_starts_on_page||"",path:e.chapter.$path,size:"small",hide_validation:!0,can_edit:!0,options:e.starts_on_page_options}})],1):e._e()]):e._e(),t("div",{staticClass:"_content"},[e.chapter.section_type==="text"?[e.chapter._main_text?[t("DLabel",{attrs:{str:e.$t("content")}}),t("CollaborativeEditor3",{ref:"collaborativeEditor",attrs:{content:e.main_text_content,path:e.chapter._main_text.$path,custom_formats:e.custom_formats,save_format:e.save_format,content_type:"markdown",can_edit:!0,mode:"always_active"},scopedSlots:e._u([{key:"custom_buttons",fn:function(){return[t("button",{staticClass:"u-button u-button_bleumarine _customBtn",attrs:{type:"button"},on:{click:function(n){e.show_media_picker=!e.show_media_picker}}},[e._v(" "+e._s(e.$t("import_medias"))+" ")])]},proxy:!0}],null,!1,2050969443)}),e.show_media_picker?t("PickMediaForMarkdown",{attrs:{publication_path:e.publication.$path},on:{insertToText:e.insertToText,close:e.closePickModal}}):e._e()]:[t("div",{staticClass:"u-instructions"},[e._v(" "+e._s(e.$t("no_content"))+" ")])]]:e._e(),e.chapter.section_type==="gallery"?[t("transition-group",{staticClass:"_gallery",attrs:{tag:"div",name:"StoryModules",appear:""}},[e._l(e.gallery_medias,function(n){return t("div",{key:n.$path,staticClass:"_gallery--item"},[t("MediaContent",{attrs:{file:n,context:"full"}}),t("div",{staticClass:"_remove_media"},[t("RemoveMenu",{attrs:{show_button_text:!1},on:{remove:function(a){return e.removeMedia(n)}}})],1)],1)}),t("div",{key:"add_medias",staticClass:"_add_medias"},[t("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:function(n){e.show_media_picker=!0}}},[e._v(" "+e._s(e.$t("add_medias"))+" ")])])],2),e.show_media_picker?t("MediaPicker",{attrs:{publication_path:e.publication.$path,select_mode:"multiple",pick_from_types:["image"]},on:{pickMedias:e.pickMediasForGallery,close:function(n){e.show_media_picker=!1}}}):e._e()]:e._e(),e.chapter.section_type==="story"?[t("SingleSection",{staticClass:"_singleSection",attrs:{publication:e.publication,section:e.chapter,can_edit:!0}})]:e._e()],2)])])},ve=[],ye=d(me,fe,ve,!1,null,"78be4e91");const ge=ye.exports,we={props:{style_file:Object,default_styles:String,show_source_html:Boolean},components:{},data(){return{show_reset_modal:!1,show_remove_modal:!1}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{pretty_default_styles(){return $.highlight(this.default_styles,{language:"css"}).value}},methods:{async resetCustom(){this.$refs.styleEditor.restoreVersion(this.default_styles),this.show_reset_modal=!1}}};var be=function(){var e=this,t=e._self._c;return t("div",{staticClass:"_openedStyleFile"},[e.style_file.$path==="default"?[t("h2",[e._v(e._s(e.$t("default_styles")))])]:[t("TitleField",{attrs:{label:e.$t("name"),show_label:!1,field_name:"css_title",tag:"h2",content:e.style_file.css_title,path:e.style_file.$path,maxlength:40,can_edit:!0}})],t("div",{staticClass:"u-spacingBottom"}),t("div",{staticClass:"_topBtns"},[t("ToggleInput",{attrs:{content:e.show_source_html,label:e.$t("show_source_html")},on:{"update:content":function(s){return e.$emit("update:show_source_html",s)}}}),e.style_file.$path!=="default"?[t("button",{key:"resetCustom",staticClass:"u-buttonLink u-buttonLink_red",attrs:{type:"button"},on:{click:function(s){e.show_reset_modal=!0}}},[e._v(" "+e._s(e.$t("back_to_default_styles"))+" ")]),e.show_reset_modal?t("BaseModal2",{attrs:{title:e.$t("back_to_default_styles")},on:{close:function(s){e.show_reset_modal=!1},save:e.resetCustom}},[t("div",{staticClass:"defaultCode"},[t("pre",{domProps:{innerHTML:e._s(e.pretty_default_styles)}})]),t("template",{slot:"footer"},[t("SaveCancelButtons",{attrs:{cancel_text:e.$t("cancel"),save_text:e.$t("reset")},on:{save:e.resetCustom,cancel:function(s){e.show_reset_modal=!1}}})],1)],2):e._e(),t("button",{staticClass:"u-buttonLink u-buttonLink_red",attrs:{type:"button"},on:{click:function(s){e.show_remove_modal=!0}}},[t("b-icon",{attrs:{icon:"trash"}}),e._v(" "+e._s(e.$t("remove"))+" ")],1),e.show_remove_modal?t("RemoveMenu2",{attrs:{modal_title:e.$t("remove_css_file",{name:e.style_file.css_title}),path:e.style_file.$path},on:{removedSuccessfully:function(s){return e.$emit("close")},close:function(s){e.show_remove_modal=!1}}}):e._e()]:e._e()],2),e.style_file.$path!=="default"?t("CollaborativeEditor3",{key:e.style_file.$path,ref:"styleEditor",attrs:{content:e.style_file.$content,path:e.style_file.$path,custom_formats:[],save_format:"raw",mode:"always_active",can_edit:!0}}):t("div",{staticClass:"defaultCode"},[t("pre",{domProps:{innerHTML:e._s(e.pretty_default_styles)}})]),t("div",{staticClass:"u-spacingBottom"})],2)},$e=[],xe=d(we,be,$e,!1,null,"e0c28339");const ke=xe.exports,Ce={props:{publication:Object,opened_style_file_meta:String,show_source_html:Boolean},components:{OpenedGraphicStyles:ke},data(){return{default_styles:u,show_create_css_modal:!1,new_css_title:""}},created(){},mounted(){},beforeDestroy(){this.$emit("update:show_source_html",!1)},watch:{},computed:{pretty_default_styles(){return $.highlight(this.default_styles,{language:"css"}).value},style_files(){var i;return(i=this.publication.$files)==null?void 0:i.filter(e=>e.is_css_styles===!0).sort((e,t)=>{const s=e.css_title||this.getFilename(e.$path),n=t.css_title||this.getFilename(t.$path);if(s<n)return-1;if(s>n)return 1})},opened_style_file(){return this.opened_style_file_meta==="default"||this.style_files.length===0?{$path:"default",css_title:this.$t("default_styles"),$content:u,is_default:!0}:this.style_files.find(i=>this.getFilename(i.$path)===this.opened_style_file_meta)}},methods:{async createCustomStylesheet(){const i=this.new_css_title+".css",{meta_filename:e}=await this.$api.uploadText({path:this.publication.$path,filename:i,content:u,additional_meta:{$type:"text",css_title:this.new_css_title,is_css_styles:!0}});this.new_css_title="",this.show_create_css_modal=!1,this.$emit("setStyleFile",e)},async resetCustom(){this.$refs.styleEditor.restoreVersion(u)},openStyleFile(i){this.$emit("setStyleFile",this.getFilename(i))},openDefaultStyles(){this.$emit("setStyleFile","default")}}};var Se=function(){var s;var e=this,t=e._self._c;return t("div",{staticClass:"_editGraphicStyles"},[t("div",{staticClass:"_close_button"},[t("button",{staticClass:"u-button u-button_icon",attrs:{type:"button"},on:{click:function(n){return e.$emit("close")}}},[t("b-icon",{attrs:{icon:"x-lg",label:e.$t("close")}})],1)]),t("div",{staticClass:"_topTabs"},[e._l(e.style_files,function(n){var a;return t("button",{key:n.$path,staticClass:"u-button",class:{"is--active":((a=e.opened_style_file)==null?void 0:a.$path)===n.$path},attrs:{type:"button"},on:{click:function(o){return e.openStyleFile(n.$path)}}},[e._v(" "+e._s(n.css_title||e.getFilename(n.$path))+" ")])}),t("button",{staticClass:"u-button",class:{"is--active":((s=e.opened_style_file)==null?void 0:s.$path)==="default"},attrs:{type:"button"},on:{click:e.openDefaultStyles}},[e._v(" "+e._s(e.$t("default_styles"))+" ")]),t("button",{staticClass:"u-button u-button_bleumarine",attrs:{type:"button"},on:{click:function(n){e.show_create_css_modal=!0}}},[e._v(" "+e._s(e.$t("create_custom_stylesheet"))+" ")]),e.show_create_css_modal?t("BaseModal2",{attrs:{title:e.$t("create_custom_stylesheet")},on:{close:function(n){e.show_create_css_modal=!1},save:e.createCustomStylesheet},scopedSlots:e._u([{key:"footer",fn:function(){return[t("div"),t("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:e.createCustomStylesheet}},[e._v(" "+e._s(e.$t("create_and_open"))+" ")])]},proxy:!0}],null,!1,479890664)},[t("DLabel",{attrs:{str:e.$t("name")}}),t("TextInput",{ref:"titleInput",attrs:{content:e.new_css_title,maxlength:40,required:!0,autofocus:!0},on:{"update:content":function(n){e.new_css_title=n},toggleValidity:n=>e.allow_save=n,onEnter:e.createCustomStylesheet}})],1):e._e()],2),t("div",{staticClass:"_openedStyleFile"},[t("transition",{attrs:{name:"fade",mode:"out-in"}},[e.opened_style_file?t("OpenedGraphicStyles",{key:e.opened_style_file.$path,attrs:{style_file:e.opened_style_file,default_styles:e.default_styles,show_source_html:e.show_source_html},on:{"update:show_source_html":function(n){return e.$emit("update:show_source_html",n)},close:e.openDefaultStyles}}):e._e()],1)],1)])},Pe=[],ze=d(Ce,Se,Pe,!1,null,"3a007ad5");const Me=ze.exports,Fe={props:{publication:Object,force_layout_mode:String},components:{},data(){return{edit_mode:!1,is_saving:!1,can_edit:!0,new_layout_mode:void 0,new_page_width:void 0,new_page_height:void 0}},created(){},mounted(){this.initValues()},beforeDestroy(){},watch:{new_layout_mode(){const{width:i,height:e}=this.format_options[0];this.new_page_width||(this.new_page_width=i),this.new_page_height||(this.new_page_height=e)}},computed:{format_options(){return this.new_layout_mode==="print"?[{key:"A4_portrait",text:this.$t("A4_portrait"),width:210,height:297},{key:"A4_landscape",text:this.$t("A4_landscape"),width:297,height:210},{key:"A5_portrait",text:this.$t("A5_portrait"),width:148,height:210},{key:"A5_landscape",text:this.$t("A5_landscape"),width:210,height:148},{key:"custom",text:this.$t("custom")}]:[{key:"recommended",text:this.$t("recommended"),width:960,height:700},{key:"desktop1080",text:this.$t("desktop_1080"),width:1920,height:1080},{key:"desktop720",text:this.$t("desktop_720"),width:1280,height:720},{key:"custom",text:this.$t("custom")}]},predefined_format_from_width(){const i=this.format_options.find(e=>e.width===this.new_page_width&&e.height===this.new_page_height);return i?i.key:"custom"},unit(){return this.new_layout_mode==="screen"?"px":"mm"}},methods:{initValues(){this.force_layout_mode?this.new_layout_mode=this.force_layout_mode:this.new_layout_mode=this.publication.layout_mode||"print",this.new_page_width=this.publication.page_width||210,this.new_page_height=this.publication.page_height||297},enableEditMode(){this.edit_mode=!0},setSizeFromFormat(i){const e=i.target.value;if(e==="custom")return;const t=this.format_options.find(s=>s.key===e);this.new_page_width=t.width,this.new_page_height=t.height},cancel(){this.edit_mode=!1,this.is_saving=!1,this.initValues()},async updateSize(){this.is_saving=!0;try{const i={layout_mode:this.new_layout_mode,page_width:this.new_page_width,page_height:this.new_page_height};await this.$api.updateMeta({path:this.publication.$path,new_meta:i}),this.edit_mode=!1,this.is_saving=!1}catch(i){this.is_saving=!1,this.edit_mode=!1,this.$alertify.closeLogOnClick(!0).delay(4e3).error(this.$t("couldntbesaved")),this.$alertify.closeLogOnClick(!0).error(i.response.data)}}}};var Ee=function(){var e=this,t=e._self._c;return t("div",{staticClass:"_widthHeightField"},[t("fieldset",[t("legend",{staticClass:"u-label"},[e._v(e._s(e.$t("format")))]),e.can_edit&&!e.edit_mode?t("EditBtn",{attrs:{is_unfolded:!0},on:{click:e.enableEditMode}}):e._e(),t("br"),t("br"),e.force_layout_mode?e._e():[t("DLabel",{staticClass:"_label",attrs:{str:e.$t("document_type"),tag:"H3"}}),e._l([{key:"print",label:e.$t("print"),instructions:e.$t("print_instr")},{key:"screen",label:e.$t("screen"),instructions:e.$t("screen_instr")}],function(s){return t("div",{key:s.key},[t("div",[t("input",{directives:[{name:"model",rawName:"v-model",value:e.new_layout_mode,expression:"new_layout_mode"}],attrs:{type:"radio",name:s.key,id:"radioi-lmode-"+s.key,disabled:!e.edit_mode},domProps:{value:s.key,checked:e._q(e.new_layout_mode,s.key)},on:{change:function(n){e.new_layout_mode=s.key}}}),t("label",{attrs:{for:"radioi-lmode-"+s.key}},[e._v(" "+e._s(s.label)),t("br"),t("small",{domProps:{innerHTML:e._s(s.instructions)}})])])])})],t("br"),t("transition",{attrs:{name:"fade",mode:"out-in"}},[t("div",{key:e.new_layout_mode},[t("DLabel",{staticClass:"_label",attrs:{str:e.$t("format"),tag:"h3",instructions:e.$t("format_instructions")}}),[t("select",{attrs:{disabled:!e.edit_mode},domProps:{value:e.predefined_format_from_width},on:{change:e.setSizeFromFormat}},e._l(e.format_options,function(s){return t("option",{key:s.key,domProps:{value:s.key,textContent:e._s(s.text)}})}),0)],t("div",{staticClass:"u-sameRow"},[t("div",{},[t("DLabel",{attrs:{str:e.$t("width")}}),t("div",{staticClass:"u-inputGroup"},[t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.new_page_width,expression:"new_page_width",modifiers:{number:!0}}],attrs:{type:"number",disabled:!e.edit_mode},domProps:{value:e.new_page_width},on:{input:function(s){s.target.composing||(e.new_page_width=e._n(s.target.value))},blur:function(s){return e.$forceUpdate()}}}),t("span",{staticClass:"u-suffix",domProps:{textContent:e._s(e.unit)}})])],1),t("div",{},[t("DLabel",{attrs:{str:e.$t("height")}}),t("div",{staticClass:"u-inputGroup"},[t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.new_page_height,expression:"new_page_height",modifiers:{number:!0}}],attrs:{type:"number",disabled:!e.edit_mode},domProps:{value:e.new_page_height},on:{input:function(s){s.target.composing||(e.new_page_height=e._n(s.target.value))},blur:function(s){return e.$forceUpdate()}}}),t("span",{staticClass:"u-suffix",domProps:{textContent:e._s(e.unit)}})])],1)])],2)]),e.edit_mode?t("div",{staticClass:"_footer"},[t("SaveCancelButtons",{staticClass:"_scb",attrs:{is_saving:e.is_saving},on:{save:e.updateSize,cancel:e.cancel}})],1):e._e()],2)])},Te=[],Oe=d(Fe,Ee,Te,!1,null,"ff3922ae");const De=Oe.exports,Re={props:{publication:Object,pane_infos:Object,can_edit:Boolean},components:{Splitpanes:I,Pane:J,ChaptersSummary:le,OpenChapter:ge,ViewContent:M,GraphicStyles:Me,PublicationSettings:F,WidthHeightField:De},provide(){return{$getMetaFilenamesAlreadyPresent:()=>this.meta_filenames_already_present}},data(){return{show_edit_pane:!0,show_preview_pane:!0,show_source_html:!1,chapters_positions:{}}},created(){},mounted(){},beforeDestroy(){this.$emit("updatePane",{key:"chapter",value:!1})},watch:{},computed:{view_mode(){var i;return((i=this.$route.query)==null?void 0:i.view_mode)||"book"},all_chapters(){return this.getSectionsWithProps({publication:this.publication,group:"sections_list"}).map(i=>(i.main_text_meta&&(i._main_text=this.publication.$files.find(e=>e.$path.endsWith("/"+i.main_text_meta))),i.section_type||(i.section_type="text"),i))},opened_section_meta_filename(){return this.pane_infos.chapter},opened_chapter(){return this.opened_section_meta_filename?this.all_chapters.find(i=>i.$path.endsWith(this.opened_section_meta_filename)):!1},prev_section(){if(!this.opened_chapter)return!1;const i=this.all_chapters.findIndex(e=>e.$path.endsWith(this.opened_section_meta_filename));return this.all_chapters[i-1]},next_section(){if(!this.opened_chapter)return!1;const i=this.all_chapters.findIndex(e=>e.$path.endsWith(this.opened_section_meta_filename));return this.all_chapters[i+1]},show_graphic_styles(){var i;return((i=this.pane_infos)==null?void 0:i.edit_graphics)===!0},opened_style_file_meta(){var i;return((i=this.pane_infos)==null?void 0:i.style)||"first"},meta_filenames_already_present(){let i=[],e=[];return this.all_chapters.forEach(t=>{Array.isArray(t.source_medias)&&t.source_medias.forEach(s=>{this.getFilename(t.$path)===this.opened_section_meta_filename?i.push(s.meta_filename_in_project):e.push(s.meta_filename_in_project)})}),[{label:this.$t("in_this_section"),medias:i,color:"var(--c-orange)"},{label:this.$t("in_another_section"),medias:e,color:"var(--c-bleuvert)"}]}},methods:{openChapter(i){const t=this.all_chapters.findIndex(s=>s.$path.endsWith(this.opened_section_meta_filename))+i;if(t>=0&&t<=this.all_chapters.length-1){const s=this.getFilename(this.all_chapters[t].$path);this.$emit("updatePane",{key:"chapter",value:s})}},async removeChapter(i){i._main_text&&await this.$api.deleteItem({path:i._main_text.$path}),await this.$api.deleteItem({path:i.$path})},getChapterPosition(i){const e=this.getFilename(i);return this.chapters_positions[e]}}};var je=function(){var e=this,t=e._self._c;return t("div",{staticClass:"_editionTemplate"},[e.can_edit?t("splitpanes",{staticClass:"_splitpanes"},[e.show_edit_pane?t("pane",[t("div",{staticClass:"_chapterSummary"},[t("div",{staticClass:"_chapterSummary--content"},[t("div",{staticClass:"_showPreviewBtn"},[t("ToggleInput",{attrs:{content:e.show_preview_pane,label:e.$t("show_preview")+" ➵"},on:{"update:content":function(s){e.show_preview_pane=s}}})],1),t("ChaptersSummary",{attrs:{publication:e.publication,sections:e.all_chapters,opened_section_meta_filename:e.opened_section_meta_filename,view_mode:e.view_mode,chapters_positions:e.chapters_positions},on:{removeChapter:e.removeChapter,toggleSection:function(s){return e.$emit("updatePane",{key:"chapter",value:s})}}})],1)]),t("div",{staticClass:"_editGraphics"},[e._e()]),t("transition",{attrs:{name:"pagechange",mode:"in-out"}},[e.show_graphic_styles?t("GraphicStyles",{key:"edit_graphics",attrs:{publication:e.publication,opened_style_file_meta:e.opened_style_file_meta,show_source_html:e.show_source_html},on:{"update:show_source_html":function(s){e.show_source_html=s},close:function(s){return e.$emit("updatePane",{key:"edit_graphics",value:!1})},setStyleFile:function(s){return e.$emit("updatePane",{key:"style",value:s})}}}):e.opened_chapter?t("OpenChapter",{key:e.opened_chapter.$path,attrs:{chapter:e.opened_chapter,chapters:e.all_chapters,prev_section:e.prev_section,next_section:e.next_section,publication:e.publication,chapter_position:e.getChapterPosition(e.opened_chapter.$path),view_mode:e.view_mode},on:{remove:function(s){return e.removeChapter(e.opened_chapter)},close:function(s){return e.$emit("updatePane",{key:"chapter",value:!1})},prev:function(s){return e.openChapter(-1)},next:function(s){return e.openChapter(1)}}}):e._e()],1)],1):e._e(),e.show_preview_pane?t("pane",[t("div",{staticClass:"_viewer"},[t("ViewContent",{attrs:{publication:e.publication,opened_chapter_meta_filename:e.opened_section_meta_filename,view_mode:e.view_mode,opened_style_file_meta:e.opened_style_file_meta,show_source_html:e.show_source_html,show_source_html_toggle:e.can_edit&&e.view_mode==="book",can_edit:e.can_edit},on:{"update:show_source_html":function(s){e.show_source_html=s},openChapter:function(s){return e.$emit("updatePane",{key:"chapter",value:s})},changeView:function(s){return e.$emit("updatePane",{key:"view_mode",value:s})},setStyleFile:function(s){return e.$emit("updatePane",{key:"style",value:s})},updateChaptersPositions:function(s){e.chapters_positions=s}}})],1)]):e._e()],1):e._e(),e.can_edit?t("PublicationSettings",[t("WidthHeightField",{attrs:{publication:e.publication,force_layout_mode:"print"}})],1):t("div",{staticClass:"_previewMode"},[t("ViewContent",{attrs:{publication:e.publication,opened_chapter_meta_filename:e.opened_section_meta_filename,view_mode:e.view_mode,opened_style_file_meta:e.opened_style_file_meta,viewer_type:"div",can_edit:!1},on:{openChapter:function(s){return e.$emit("updatePane",{key:"chapter",value:s})},changeView:function(s){return e.$emit("updatePane",{key:"view_mode",value:s})},setStyleFile:function(s){return e.$emit("updatePane",{key:"style",value:s})}}})],1)],1)},Be=[],Ne=d(Re,je,Be,!1,null,"db184ece");const We=Ne.exports;export{We as default};
