import{K as h}from"./KeywordsField-B8AZHPAc.js";import{n as m}from"../build.js";function c(o,t=0,e=2e3,i="easeOutSine",s=()=>{}){var r=o.scrollTop||document.documentElement.scrollTop,a=0,_=Math.max(.1,Math.min(Math.abs(r-t)/e,1.6)),l={easeOutSine:function(n){return Math.sin(n*(Math.PI/2))},easeInOutSine:function(n){return-.5*(Math.cos(Math.PI*n)-1)},easeInOutQuint:function(n){return(n/=.5)<1?.5*Math.pow(n,5):.5*(Math.pow(n-2,5)+2)}};function d(){a+=1/60;var n=a/_,u=l[i](n);n<1?(window.requestAnimationFrame(d),o.scrollTop=r+(t-r)*u):(o.scrollTop=t,s())}d()}const w={props:{publication:Object},components:{KeywordsField:h},data(){return{scroll_y:0,scroll_height:void 0,slide_to_show:0,window_width:void 0,window_height:void 0,number_of_modules_to_keep_visible_at_once:8,restart_autoscroll_on_end:!0,number_of_different_layouts:10,left_right_margin:40,top_margin:40,bottom_margin:200,random_layouts_options:[],all_layouts:[{w:70},{w:64},{w:60},{w:80},{w:100}]}},created(){this.all_layouts=this.all_layouts.map(o=>({...o,rnd:Math.random()})),this.random_layouts_options=this.fillWithRandoms({items:100,number_of_different_layouts:this.all_layouts.length})},mounted(){this.$nextTick(()=>{this.onResize()}),window.addEventListener("resize",this.onResize),this.is_autoscroll===!0&&setTimeout(()=>{this.startAutomaticScroll()},1e3),history.scrollRestoration?history.scrollRestoration="manual":window.onbeforeunload=function(){window.scrollTo(0,0)}},beforeDestroy(){window.removeEventListener("resize",this.onResize)},watch:{},computed:{first_section(){return this.getSectionsWithProps({publication:this.publication,group:"sections_list"})[0]},is_autoscroll(){var o;return((o=this.$route.query)==null?void 0:o.scroll)==="auto"},section_modules_list(){return this.getModulesForSection({publication:this.publication,section:this.first_section}).map(({_module:o})=>o)},currently_shown_module_index(){return Math.floor(this.scroll_y/this.window_height-.1)},currently_shown_module(){return this.section_modules_list[this.currently_shown_module_index]}},methods:{onResize(){this.window_width=window.innerWidth,this.window_height=window.innerHeight,this.scroll_height=this.window_height*this.section_modules_list.length,this.onScroll()},fillWithRandoms({items:o,number_of_different_layouts:t}){let e=[];for(;e.length<o;){const i=new Array(t).fill(1).map((s,r)=>r).map(s=>({value:s,sort:Math.random()})).sort((s,r)=>s.sort-r.sort).map(({value:s})=>s);e=e.concat(i)}return e},slideRandomLayout(o,t){var u;if(!t)return;const e=this.random_layouts_options[o%this.random_layouts_options.length],i=this.all_layouts[e],s=((u=t.$infos)==null?void 0:u.ratio)||1,r=this.window_width-this.left_right_margin*2,a=this.window_height-this.bottom_margin-this.top_margin;let _=i.w/100*r,l=_*s;l>a&&(l=a,_=l/s);const d=Math.round((a-l)*i.rnd)+this.top_margin,n=Math.round((r-_)*i.rnd)+this.left_right_margin;return{"--ratio":s,"--rnd":i.rnd,width:_+"px",height:l+"px",marginTop:d+"px",marginLeft:n+"px"}},getFirstSourceMedia(o){const t=o[0];return t?this.getSourceMedia({source_media:{meta_filename:t.meta_filename},folder_path:this.publication.$path}):!1},onScroll(o){this.scroll_y=this.$refs.agoraView.scrollTop},async startAutomaticScroll(){var e;console.log("showing slide number",this.slide_to_show),this.prepareForPlay(this.slide_to_show),this.scrollToSlide(this.slide_to_show),await this.waitFor(1e3),this.stopAllVideos(),this.autoPlayVideo(this.slide_to_show);let t;t=((e=this.section_modules_list[this.slide_to_show])==null?void 0:e.duration)*1e3||8e3,console.log("will show slide for",t,"ms"),await this.waitFor(t),this.slide_to_show<this.section_modules_list.length-1?(this.slide_to_show+=1,this.startAutomaticScroll()):(console.log("Last slide"),this.restart_autoscroll_on_end&&c(this.$refs.agoraView,0,2e3,"easeOutSine",async()=>{await this.waitFor(1e3),this.slide_to_show=0,this.startAutomaticScroll()}))},waitFor(o){return new Promise(t=>setTimeout(t,o))},scrollToSlide(o,t){const e=o*window.innerHeight+window.innerHeight;c(this.$refs.agoraView,e,2e3,"easeOutSine",t)},autoPlayVideo(o){const t=this.findModuleElementFromIndex(o);if(!t)return!1;const e=t.querySelector("video");if(!e)return!1;e.muted=!0,e.currentTime=0;const i=t.querySelector("[data-plyr='play']");i&&i.click()},prepareForPlay(o){const t=this.findModuleElementFromIndex(o);if(!t)return!1;const e=t.querySelector("video");if(!e)return!1;e.controls=!1,e.muted=!0,e.currentTime=.1},findModuleElementFromIndex(o){var e;const t=(e=this.section_modules_list[o])==null?void 0:e.$path;if(t)return this.$el.querySelector(`[data-modulepath="${t}"]`)},stopAllVideos(){this.$el.querySelectorAll("video").forEach(o=>{o.pause()})}}};var f=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_agoraExport",attrs:{"data-autoscroll":t.is_autoscroll===!0}},[e("div",{ref:"agoraView",staticClass:"_agoraExport--items",on:{scroll:t.onScroll}},[e("div",{staticClass:"_item"},[e("div",{staticClass:"_item--content _firstEmptySlide"},[e("transition",{attrs:{name:"fade",mode:"out-in"}},[t.currently_shown_module_index===-1&&t.is_autoscroll===!1?e("button",{staticClass:"u-button u-button_icon",on:{click:function(i){t.slide_to_show=1}}},[e("b-icon",{attrs:{icon:"arrow-down"}})],1):t._e()])],1)]),t._l(t.section_modules_list,function(i,s){return e("div",{key:i.$path,staticClass:"_item",attrs:{"data-modulepath":i.$path,"data-iscurrent":s===t.currently_shown_module_index,"data-stickied":s<t.currently_shown_module_index}},[e("transition",{attrs:{name:"fade",mode:"out-in"}},[s>t.currently_shown_module_index-t.number_of_modules_to_keep_visible_at_once?e("div",{staticClass:"_item--content",style:t.slideRandomLayout(s,t.getFirstSourceMedia(i.source_medias))},[t.getFirstSourceMedia(i.source_medias)?[e("MediaContent",{attrs:{file:t.getFirstSourceMedia(i.source_medias),resolution:1600,context:"full",show_fs_button:!1}})]:[e("div",[t._v("Erreur au chargement du m√©dia")])],e("transition",{attrs:{name:"slideoverlay",mode:"out-in"}},[s<t.currently_shown_module_index?e("div",{staticClass:"_overlay"}):t._e()])],2):t._e()])],1)})],2),e("transition",{attrs:{name:"showkeywords",mode:"out-in"}},[t.currently_shown_module&&t.currently_shown_module.keywords?e("div",{key:t.currently_shown_module.$path,staticClass:"_agoraExport--bottom"},[e("div",{staticClass:"_keywords"},[e("KeywordsField",{attrs:{field_name:"keywords",keywords:t.currently_shown_module.keywords,can_edit:!1}})],1)]):t._e()]),e("div",{staticClass:"_scrollIndicator",style:{"--scroll-progress":t.scroll_y/t.scroll_height}})],1)},p=[],y=m(w,f,p,!1,null,"6cfa85eb");const b=y.exports;export{b as default};
