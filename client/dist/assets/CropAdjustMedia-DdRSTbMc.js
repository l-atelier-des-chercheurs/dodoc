import r from"./CropMedia-D0BdbSrq.js";import{n as o}from"../build.js";const c={props:{image:String},components:{},data(){return{brightness:100,contrast:100,saturation:100,blur:0,img_width:null,img_height:null}},created(){},async mounted(){await this.draw()},beforeDestroy(){},watch:{brightness:function(){this.draw()},contrast:function(){this.draw()},saturation:function(){this.draw()},blur:function(){this.draw()}},computed:{},methods:{async draw(){let i=new Image;i.src=this.image,await i.decode();const t=this.$refs.canvas;t.width=i.width,t.height=i.height,this.img_width=i.width,this.img_height=i.height;const a=t.getContext("2d");let e=[];e.push(`saturate(${this.saturation}%)`),e.push(`brightness(${this.brightness}%)`),e.push(`contrast(${this.contrast}%)`),e.push(`blur(${this.blur}px)`),a.filter=e.join(" "),a.drawImage(i,0,0)},async updateAdjust(){const i=this.$refs.canvas;this.$emit("updateAdjust",i.toDataURL())}}};var l=function(){var t=this,a=t._self._c;return a("div",{staticClass:"_adjustMedia"},[a("div",{staticClass:"_panes"},[a("div",{staticClass:"_settings"},[t.img_width&&t.img_height?a("ResolutionDisplay",{attrs:{width:t.img_width,height:t.img_height}}):t._e(),a("hr"),a("RangeValueInput",{staticClass:"u-spacingBottom",attrs:{label:t.$t("brightness"),value:t.brightness,can_toggle:!1,min:0,max:200,step:1,default_value:100,suffix:"%",ticks:[100]},on:{input:function(e){t.brightness=e},save:function(e){t.brightness=e}}}),a("RangeValueInput",{staticClass:"u-spacingBottom",attrs:{label:t.$t("contrast"),value:t.contrast,can_toggle:!1,min:0,max:200,step:1,default_value:100,suffix:"%",ticks:[100]},on:{input:function(e){t.contrast=e},save:function(e){t.contrast=e}}}),a("RangeValueInput",{staticClass:"u-spacingBottom",attrs:{label:t.$t("saturation"),value:t.saturation,can_toggle:!1,min:0,max:200,step:1,default_value:100,suffix:"%",ticks:[100]},on:{input:function(e){t.saturation=e},save:function(e){t.saturation=e}}}),a("RangeValueInput",{staticClass:"u-spacingBottom",attrs:{label:t.$t("blur"),value:t.blur,can_toggle:!1,min:0,max:100,step:1,default_value:0,suffix:"px",ticks:[0]},on:{input:function(e){t.blur=e},save:function(e){t.blur=e}}})],1),a("div",{staticClass:"_preview"},[a("canvas",{ref:"canvas"})])]),a("div",{staticClass:"_bottomBar"},[a("button",{staticClass:"u-button u-button_white",attrs:{type:"button"},on:{click:function(e){return t.$emit("back")}}},[a("b-icon",{attrs:{icon:"arrow-left-short"}}),t._v(" "+t._s(t.$t("previous"))+" ")],1),a("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:t.updateAdjust}},[t._v(" "+t._s(t.$t("next"))+" "),a("b-icon",{attrs:{icon:"arrow-right"}})],1)])])},u=[],_=o(c,l,u,!1,null,"6171301d");const d=_.exports,m={props:{media:Object,project_path:String},components:{CropMedia:r,AdjustMedia:d},data(){return{is_saving:!1,media_being_sent_percent:0,current_step:"crop",cropped_image:null,final_image:null,saturation:1}},created(){},mounted(){},beforeDestroy(){},watch:{saturation(i){}},computed:{final_image_filename(){let i=this.media.$media_filename.endsWith(".png")?".png":".jpg";return this.getFilenameWithoutExt(this.media.$media_filename)+"_edit"+i},final_image_blob(){return this.dataURLtoBlob(this.final_image)}},methods:{updateCrop(i){this.cropped_image=i,this.current_step="adjust"},updateAdjust(i){this.final_image=i,this.current_step="export"},goBack(){this.current_step="adjust"},async buttonSaveAsNew(){await this.saveAsNew(),this.$emit("closeParentModal")},async saveAsNew(){console.log("saveAsNew"),this.is_saving=!0;const i=this.getParent(this.media.$path);let t={$origin:"collect"};this.media.caption&&(t.caption=this.media.caption),this.media.$credits&&(t.$credits=this.media.$credits),this.media.keywords&&(t.keywords=this.media.keywords),this.media.$authors&&(t.$authors=this.media.$authors),this.media.$location&&(t.$location=this.media.$location);const a=n=>{this.media_being_sent_percent=parseInt(Math.round(n.loaded*100/n.total))},{uploaded_meta:e,meta_filename:s}=await this.$api.uploadFile({path:i,filename:this.final_image_filename,file:this.final_image_blob,additional_meta:t,onProgress:a}).catch(n=>{throw this.$alertify.closeLogOnClick(!0).delay(4e3).error(this.$t("media_couldnt_be_sent")),n});return this.is_saving=!1,{uploaded_meta:e,meta_filename:s}},async replaceOriginal(){const{uploaded_meta:i,meta_filename:t}=await this.saveAsNew(),a=this.getParent(this.media.$path)+"/"+t,e=this.media.$media_filename,s=i.$media_filename;await this.$api.updateMeta({path:this.media.$path,new_meta:{$media_filename:s}}),await this.$api.updateMeta({path:a,new_meta:{$media_filename:e}}),await this.$api.deleteItem({path:a}),this.$emit("closeParentModal")}}};var p=function(){var t=this,a=t._self._c;return a("div",{staticClass:"_cropAdjustMedia"},[a("BaseModal2",{attrs:{title:t.$t("crop_adjust"),size:"full"},on:{close:function(e){return t.$emit("close")}}},[a("div",{staticClass:"_cont"},[a("div",{staticClass:"_steps"},t._l(["crop","adjust","export"],function(e,s){return a("span",{key:e,staticClass:"_step"},[a(e===t.current_step?"strong":"span",{tag:"component"},[t._v(" "+t._s(t.$t(e))+" ")]),s!==2?a("b-icon",{attrs:{icon:"chevron-right","aria-role":"presentation"}}):t._e()],1)}),0),a("div",{staticClass:"_panes"},[t.current_step==="crop"?a("CropMedia",{attrs:{media:t.media},on:{updateCrop:t.updateCrop}}):t._e(),t.current_step==="adjust"?a("AdjustMedia",{attrs:{image:t.cropped_image},on:{back:function(e){t.current_step="crop"},updateAdjust:t.updateAdjust}}):t._e(),t.current_step==="export"?a("div",{staticClass:"_exportPane"},[a("img",{attrs:{src:t.final_image}}),a("div",{staticClass:"_btnRow"},[a("button",{staticClass:"u-button u-button_white",attrs:{type:"button"},on:{click:t.goBack}},[a("b-icon",{attrs:{icon:"arrow-left-short"}}),t._v(" "+t._s(t.$t("previous"))+" ")],1),a("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:t.buttonSaveAsNew}},[a("b-icon",{attrs:{icon:"file-plus"}}),t._v(" "+t._s(t.$t("save_as_new_media"))+" ")],1),a("button",{staticClass:"u-button u-button_red",attrs:{type:"button"},on:{click:t.replaceOriginal}},[a("b-icon",{attrs:{icon:"save2-fill"}}),t._v(" "+t._s(t.$t("replace_original"))+" ")],1),a("div",{staticClass:"_download_media_without_validation"},[a("small",[a("a",{ref:"",attrs:{href:t.final_image_blob,download:t.final_image_filename,target:"_blank"}},[t._v(" "+t._s(t.$t("or_download_media_on_device"))+" "),t.final_image_blob?[t._v(" â€” "+t._s(t.formatBytes(t.final_image_blob.size))+" ")]:t._e()],2)])]),t.is_saving?a("div",{key:"loader",staticClass:"_spinner"},[a("AnimatedCounter",{attrs:{value:t.media_being_sent_percent}})],1):t._e()])]):t._e()],1)])])],1)},h=[],f=o(m,p,h,!1,null,"f3ede82e");const v=f.exports;export{v as default};
